function fieldval_ui_extend(e,t){function i(){}i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e,e.superConstructor=t,e.superClass=t.prototype}function FVField(e,t){var i=this;i.name=e,i.options=t||{},i.output_flag=!0,i.is_in_array=!1,i.key_value_parent=null,i.is_in_key_value=!1,i.is_disabled=!1,i.on_change_callbacks=[],i.options.form?(i.element=$("<form />").addClass("fv_field").data("field",i).on("submit",function(e){return e.preventDefault(),i.submit(),!1}),i.on_submit_callbacks=[]):i.element=$("<div />").addClass("fv_field").data("field",i),i.title=$("<div />").addClass("fv_field_title").text(i.name),i.name||i.title.hide(),i.options.description&&(i.description_label=$("<div />").addClass("fv_field_description").text(i.options.description)),i.input_holder=$("<div />").addClass("fv_input_holder"),i.error_message=$("<div />").addClass("fv_error_message").hide(),i.layout()}function FVTextField(e,t){var i=this,r=typeof t;"string"===r?(i.input_type=t,t={}):"object"===r?i.input_type=t.type||"text":t={},FVTextField.superConstructor.call(this,e,t),i.element.addClass("fv_text_field"),i.input=$("textarea"===i.input_type?"<textarea />":"text"!==i.input_type&&"number"!==i.input_type&&i.input_type?"<input type='"+i.input_type+"' />":"<input type='text' />"),i.enter_callbacks=[],i.previous_value={},i.input.addClass("fv_text_input").attr("placeholder",e).on("keydown",function(e){if(13===e.keyCode)for(var t=0;t<i.enter_callbacks.length;t++)i.enter_callbacks[t](e)}).on("keyup paste cut",function(){setTimeout(function(){i.check_changed()},0)}).appendTo(i.input_holder)}function FVPasswordField(e){FVPasswordField.superConstructor.call(this,e,{type:"password"})}function FVDisplayField(e,t){var i=this;FVDisplayField.superConstructor.call(this,e,t),i.element.addClass("fv_display_field"),i.input=$("<div />").appendTo(i.input_holder),i.output_flag=!1}function FVChoiceOption(e,t){var i=this;i.parent=t,null===e?(i.choice_text=t.empty_text,i.choice_value=null):"object"==typeof e?(i.choice_value=e[0],i.choice_text=e[1].toString()):(i.choice_value=e,i.choice_text=e.toString()),i.element=$("<div />").addClass("fv_choice_option").text(i.choice_text).on("mousedown",function(){t.mousedown()}).on("mouseup",function(){t.mouseup()}).on(FVForm.button_event,function(e){t.default_click(e,i)})}function FVChoiceField(e,t){var i=this;if(FVChoiceField.superConstructor.call(this,e,t),i.element.addClass("fv_choice_field"),i.choices=i.options.choices||[],i.allow_empty=i.options.allow_empty||!1,i.empty_text=i.options.empty_text||"",i.option_array=[],i.selected_value=null,i.option_class=t.option_class||FVChoiceOption,i.select=$("<div/>").addClass("fv_choice_input").append(i.filter_input=$("<input type='text' />").on("focus",function(){i.focus()}).attr("placeholder",e).addClass("filter_input").on("blur",function(){i.is_mousedown||i.blur()}),i.current_display=$("<div />").addClass("fv_choice_display fv_choice_placeholder").on(FVForm.button_event,function(){i.focus()}).text(i.name),i.choice_list=$("<div />").addClass("fv_choice_list").bind("mousewheel DOMMouseScroll",function(e){var t=null;"mousewheel"==e.type?t=e.originalEvent.wheelDelta*-.5:"DOMMouseScroll"==e.type&&(t=40*e.originalEvent.detail),t&&(e.preventDefault(),$(this).scrollTop(t+$(this).scrollTop()))})).appendTo(i.input_holder),i.filter_input.addClass("fv_filter_hidden").on("keydown",function(e){i.filter_key_down(e)}).on("keyup",function(e){i.filter_key_up(e)}),$("html").on(FVForm.button_event,function(e){i.filter_input.is(":visible")&&($(e.target).closest(i.filter_input).length||i.hide_list())}),i.allow_empty){var r=new i.option_class(null,i);i.option_array.push(r),i.add_option(r)}for(var o=0;o<i.choices.length;o++){var n=i.choices[o],r=new i.option_class(n,i);i.option_array.push(r),i.add_option(r)}i.filter("")}function FVDateField(e,t){var i=this;if("undefined"==typeof DateVal)return void console.error("FVDateField requires the FieldVal package");FVDateField.superConstructor.call(this,e,t),i.element.addClass("fv_date_field"),i.format_string=i.options.format||"yyyy-MM-dd";var r=DateVal.date_format().check(i.format_string,function(e){i.format_array=e});if(r)return void console.error(r.error_message);i.inputs=[];for(var o=0;o<i.format_array.length;o++){var n=i.format_array[o],l=DateVal.date_components[n];i.add_element_from_component(n,l)}}function FVBooleanField(e,t){var i=this;FVBooleanField.superConstructor.call(this,e,t),i.element.addClass("fv_boolean_field"),i.input=$("<input type='checkbox' />").addClass("fv_boolean_input").on("change",function(){i.did_change()}).appendTo(i.input_holder)}function FVObjectField(e,t){var i=this;FVObjectField.superConstructor.call(this,e,t),i.element.addClass("fv_object_field"),i.fields_element=i.input_holder,i.fields={}}function FVArrayField(e,t){var i=this;FVArrayField.superConstructor.call(this,e,t),i.hide_add_button=i.options.hide_add_button||!1,i.hide_remove_button=i.options.hide_remove_button||!1,i.fields=[],i.add_button_text=void 0!==i.options.add_button_text?i.options.add_button_text:"+",i.add_field_buttons=[],i.element.addClass("fv_array_field"),i.input_holder.append(i.fields_element=$("<div />").addClass("fv_array_fields")),i.hide_add_button||i.input_holder.append(i.create_add_field_button()),i.sortable=void 0===i.options.sortable||i.options.sortable!==!1,i.sortable&&(i.element.addClass("fv_array_field_sortable"),i.fields_element.nestable({rootClass:"fv_array_fields",itemClass:"fv_field",handleClass:"fv_field_move_handle",itemNodeName:"div.fv_field",listNodeName:"div",threshold:40}).on("change",function(){i.reorder()}))}function FVKeyValueField(e,t){var i=this;FVKeyValueField.superConstructor.call(this,e,t),i.fields=[],i.keys={},i.add_button_text=void 0!==i.options.add_button_text?i.options.add_button_text:"+",i.add_field_buttons=[],i.element.addClass("fv_key_value_field"),i.input_holder.append(i.fields_element=$("<div />").addClass("fv_key_value_fields"),i.create_add_field_button())}function FVProxyField(e,t){var i=this;FVProxyField.superConstructor.call(this,e,t),i.element.addClass("fv_proxy_field"),i.input_holder.append($("<div />").addClass("loading_label").text("Loading...")),i.init_called=!1,i.last_val=void 0,i.inner_field=null,i.on_replace_callbacks=[]}function FVForm(){var e=this;FVForm.superConstructor.call(this,null,{form:!0}),e.element.addClass("fv_form"),e.fields_element=e.element}FVField.prototype.on_submit=function(e){var t=this;return t.on_submit_callbacks.push(e),t},FVField.prototype.submit=function(){for(var e=this,t=e.val(),i=0;i<e.on_submit_callbacks.length;i++){var r=e.on_submit_callbacks[i];r(t)}return t},FVField.prototype.in_array=function(e,t){var i=this;i.array_parent=e,i.is_in_array=!0,i.array_remove_callback=t,i.element.addClass("fv_in_array"),i.array_parent.sortable&&i.element.append(i.move_handle=$("<div />").addClass("fv_field_move_handle")),i.array_parent.hide_remove_button||i.element.append(i.remove_button=$("<button />",{type:"button"}).addClass("fv_field_remove_button").html("&#10006;").on(FVForm.button_event,function(e){e.preventDefault(),i.array_remove_callback(i.key_name),t(),i.remove()}))},FVField.prototype.in_key_value=function(e,t){var i=this;i.key_value_parent=e,i.is_in_key_value=!0,i.key_value_remove_callback=t,i.name_input=new FVTextField("Key").on_change(function(e){i.key_name=i.key_value_parent.change_key_name(i.key_name,e,i)}),i.name_input.element.addClass("fv_key_value_name_input"),i.title.replaceWith(i.name_input.element),i.element.addClass("fv_in_key_value").append(i.remove_button=$("<button />",{type:"button"}).addClass("fv_field_remove_button").html("&#10006;").on(FVForm.button_event,function(e){e.preventDefault(),i.key_value_remove_callback(i.key_name),i.remove()}))},FVField.prototype.init=function(){},FVField.prototype.remove=function(e){var t=this;t.element.remove(),t.parent&&!e&&(t.parent.remove_field(t),t.parent=null)},FVField.prototype.change_name=function(e){var t=this;return t.name=e,t},FVField.prototype.layout=function(){var e=this;e.element.append(e.title,e.description_label,e.input_holder,e.error_message)},FVField.prototype.on_change=function(e){var t=this;return t.on_change_callbacks.push(e),t},FVField.prototype.output=function(e){var t=this;return t.output_flag=e,t},FVField.prototype.did_change=function(e){var t=this;void 0===e&&(e={});for(var i=t.val(),r=0;r<t.on_change_callbacks.length;r++){var o=t.on_change_callbacks[r];o(i)}return t.parent&&!e.ignore_parent_change&&t.parent.did_change(),t},FVField.prototype.icon=function(){},FVField.prototype.val=function(){console.error("Did not override FVField.val()")},FVField.prototype.disable=function(){var e=this;return e.is_disabled=!0,e.element.addClass("fv_disabled"),e.name_input&&e.name_input.disable(),e.move_handle&&e.move_handle.hide(),e.remove_button&&e.remove_button.hide(),e},FVField.prototype.enable=function(){var e=this;return e.is_disabled=!1,e.element.removeClass("fv_disabled"),e.name_input&&e.name_input.enable(),e.move_handle&&e.move_handle.show(),e.remove_button&&e.remove_button.show(),e},FVField.prototype.blur=function(){},FVField.prototype.focus=function(){},FVField.prototype.show_error=function(){var e=this;e.error_message.show()},FVField.prototype.hide_error=function(){var e=this;e.error_message.hide()},FVField.prototype.name_val=function(){var e=this,t=e.name_input.val.apply(e.name_input,arguments);return e.key_name=e.key_value_parent.change_key_name(e.key_name,e.name_input.val(),e),t},FVField.prototype.error=function(e){var t=this;if(e){if(t.error_message.empty(),4===e.error){for(var i=$("<ul />"),r=0;r<e.errors.length;r++){var o=e.errors[r];i.append($("<li />").text(o.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.element&&t.element.addClass("fv_field_error"),t.show_error()}else t.hide_error(),t.element&&t.element.removeClass("fv_field_error")},fieldval_ui_extend(FVTextField,FVField),FVTextField.prototype.check_changed=function(){var e=this,t=e.val();t!==e.previous_value&&(e.previous_value=t,e.did_change())},FVTextField.prototype.on_enter=function(e){var t=this;return t.enter_callbacks.push(e),t},FVTextField.prototype.icon=function(e){var t=this,i={"background-image":"url("+e.background+")","background-position":e.position,"background-repeat":"no-repeat","padding-left":e.width+"px"};return t.input.css(i),t},FVTextField.prototype.change_name=function(e){var t=this;return FVTextField.superClass.change_name.call(this,e),t.input.attr("placeholder",e),t},FVTextField.prototype.disable=function(){var e=this;return e.input.attr("disabled","disabled"),FVField.prototype.disable.call(this)},FVTextField.prototype.enable=function(){var e=this;return e.input.attr("disabled",null),FVField.prototype.enable.call(this)},FVTextField.prototype.focus=function(){var e=this;return e.input.focus(),e},FVTextField.prototype.blur=function(){var e=this;return e.input.blur(),e},FVTextField.numeric_regex=/^\d+(\.\d+)?$/,FVTextField.prototype.val=function(e,t){var i=this;if(t=t||{},0===arguments.length){var r=i.input.val();return"number"===i.input_type&&FVTextField.numeric_regex.test(r)?parseFloat(r):0===r.length?null:r}return i.input.val(e),t.ignore_change||i.did_change(t),i},fieldval_ui_extend(FVPasswordField,FVTextField),fieldval_ui_extend(FVDisplayField,FVField),FVDisplayField.prototype.icon=function(e){var t=this,i={"background-image":"url("+e.background+")","background-position":e.position,"background-repeat":"no-repeat","padding-left":e.width+"px"};return t.input.css(i),t},FVDisplayField.replace_line_breaks=function(e){if("string"!=typeof e)return e;for(var t=[],i=e.split(/\n/),r=jQuery(document.createElement("div")),o=0;o<i.length;o++)t.push(r.text(i[o]).html());return t.join("<br>")},FVDisplayField.prototype.val=function(e,t){var i=this;return t=t||{},0===arguments.length?i.input.text():(i.input.html(FVDisplayField.replace_line_breaks(e)),t.ignore_change||i.did_change(t),i)},fieldval_ui_extend(FVChoiceField,FVField),FVChoiceOption.prototype.matches_filter=function(e){var t=this;if(null===t.choice_value){if(0===e.length)return!0}else if(0===t.choice_text.toLowerCase().indexOf(e.toLowerCase()))return!0},FVChoiceOption.prototype.get_value=function(){var e=this;return e.choice_value},FVChoiceOption.prototype.add_highlight=function(){var e=this;e.element.addClass("fv_highlighted")},FVChoiceOption.prototype.remove_highlight=function(){var e=this;e.element.removeClass("fv_highlighted")},FVChoiceOption.prototype.add_selected=function(){var e=this;e.element.addClass("fv_selected")},FVChoiceOption.prototype.remove_selected=function(){var e=this;e.element.removeClass("fv_selected")},FVChoiceOption.prototype.hide=function(){var e=this;e.element.hide()},FVChoiceOption.prototype.show=function(){var e=this;e.element.show()},FVChoiceOption.prototype.get_display=function(){var e=this;return $("<div />").text(e.choice_text)},FVChoiceField.prototype.mousedown=function(){var e=this;e.is_mousedown=!0},FVChoiceField.prototype.mouseup=function(){var e=this;e.is_mousedown=!1},FVChoiceField.prototype.filter_enter_up=function(){var e=this;e.select_highlighted()},FVChoiceField.prototype.filter_esc_up=function(){var e=this;e.hide_list()},FVChoiceField.prototype.filter_key_up=function(e){var t=this;return 9===e.keyCode?void e.preventDefault():40===e.keyCode?(t.move_down(),void e.preventDefault()):38===e.keyCode?(t.move_up(),void e.preventDefault()):13===e.keyCode?(t.filter_enter_up(),void e.preventDefault()):(27===e.keyCode&&(t.filter_esc_up(),e.preventDefault()),void t.filter(t.filter_input.val()))},FVChoiceField.prototype.filter_key_down=function(e){(38===e.keyCode||40===e.keyCode||13===e.keyCode)&&e.preventDefault()},FVChoiceField.prototype.show_list=function(){var e=this;e.is_disabled||(e.input_holder.css("min-height",e.current_display.outerHeight()+"px"),e.filter_input.removeClass("fv_filter_hidden"),e.current_display.hide(),FVForm.is_mobile||e.filter_input.is(":focus")||e.filter_input.focus(),e.choice_list.show(),e.current_highlight=e.selected_value,e.filter(e.filter_input.val(),!0))},FVChoiceField.prototype.hide_list=function(){var e=this;e.current_highlight&&(e.current_highlight.remove_highlight(),e.current_highlight=null),e.input_holder.css("min-height",""),e.filter_input.addClass("fv_filter_hidden"),e.current_display.show(),e.choice_list.hide()},FVChoiceField.prototype.filter=function(e,t){var i=this;i.current_highlight&&i.current_highlight.remove_highlight();for(var r=null,o=0;o<i.option_array.length;o++){var n=i.option_array[o];n.matches_filter(e)?(n.show(),r||(r=n)):n.hide()}t&&i.current_highlight||(i.current_highlight=r),i.current_highlight&&i.current_highlight.add_highlight()},FVChoiceField.prototype.value_to_text=function(e){for(var t=this,i=0;i<t.option_array.length;i++){var r=t.option_array[i];if(r===e)return t.choice_texts[i]}return null},FVChoiceField.prototype.select_option=function(e,t){var i=this;t=t||{},i.selected_value&&i.selected_value.remove_selected(),i.selected_value=e,i.selected_value.add_selected(),null===e?i.current_display.addClass("fv_choice_placeholder").empty().text(i.name):i.current_display.removeClass("fv_choice_placeholder").empty().append(e.get_display()),i.hide_list(),i.filter_input.blur().val(""),t.ignore_change||i.did_change(t)},FVChoiceField.prototype.move_up=function(){var e=this;if(e.current_highlight){e.current_highlight.remove_highlight();var t=e.option_array.indexOf(e.current_highlight);t>0?(e.current_highlight=e.option_array[t-1],e.current_highlight.add_highlight(),e.move_into_view()):e.current_highlight=null}},FVChoiceField.prototype.move_down=function(){var e=this;if(e.current_highlight){var t=e.option_array.indexOf(e.current_highlight);t<e.option_array.length-1&&(e.current_highlight.remove_highlight(),e.current_highlight=e.option_array[t+1],e.current_highlight.add_highlight(),e.move_into_view())}else e.current_highlight=e.option_array[0],e.current_highlight&&e.current_highlight.add_highlight()},FVChoiceField.prototype.move_into_view=function(e){var t=this;void 0===e&&(e=t.current_highlight),setTimeout(function(){var i;i=e?e.element.offset().top:0,t.choice_list.scrollTop(t.choice_list.scrollTop()-t.choice_list.offset().top+i-50)},1)},FVChoiceField.prototype.add_option=function(e){var t=this;t.choice_list.append(e.element)},FVChoiceField.prototype.default_click=function(e,t){var i=this;e.preventDefault(),e.stopPropagation(),e.originalEvent&&(e.originalEvent.preventDefault(),e.originalEvent.stopPropagation()),i.select_option(t)},FVChoiceField.prototype.finalize_option=function(e){var t=this;e.appendTo(t.choice_list)},FVChoiceField.prototype.select_highlighted=function(){var e=this;e.current_highlight&&e.select_option(e.current_highlight)},FVChoiceField.prototype.focus=function(){var e=this;return e.filter_input.val(""),setTimeout(function(){e.show_list()},1),e},FVChoiceField.prototype.blur=function(){var e=this;return e.hide_list(),e},FVChoiceField.prototype.val=function(e,t){var i=this;if(0===arguments.length)return i.selected_value?i.selected_value.get_value():null;if(void 0!==e)for(var r=0;r<i.option_array.length;r++){var o=i.option_array[r];if(e===o.get_value()){i.select_option(o,t);break}}return i},fieldval_ui_extend(FVDateField,FVField),FVDateField.prototype.add_element_from_component=function(e,t){var i=this;if(0===t){var r=e;i.inputs.push(null),i.input_holder.append($("<div />").addClass("fv_date_separator").text(r))}else{var o=t[t.length-1],n=$("<input />").attr({placeholder:e,size:o,maxlength:o}).addClass("fv_date_input").on("keyup",function(){i.did_change()});n.blur(function(){var e=n.val(),i=DateVal.pad_to_valid(e,t);n.val(i)}),i.inputs.push(n),i.input_holder.append(n)}},FVDateField.prototype.icon=function(){var e=this;return e},FVDateField.prototype.change_name=function(e){var t=this;return FVDateField.superClass.change_name.call(this,e),t.input.attr("placeholder",e),t},FVDateField.prototype.disable=function(){for(var e=this,t=0;t<e.inputs.length;t++){var i=e.inputs[t];i&&i.attr("disabled","disabled")}return FVField.prototype.disable.call(this)},FVDateField.prototype.enable=function(){for(var e=this,t=0;t<e.inputs.length;t++){var i=e.inputs[t];i&&i.attr("disabled",null)}return FVField.prototype.enable.call(this)},FVDateField.prototype.focus=function(){var e=this,t=e.inputs[0];return t&&t.blur(),e},FVDateField.prototype.blur=function(){for(var e=this,t=0;t<e.inputs.length;t++){var i=e.inputs[t];i&&i.blur()}return e},FVDateField.prototype.val=function(e,t){var i=this;if(t=t||{},0===arguments.length){for(var r="",o=0;o<i.format_array.length;o++){var n=i.format_array[o],l=DateVal.date_components[n];if(0===l)r+=n;else{var a=i.inputs[o],s=a.val().toString();r+=DateVal.pad_to_valid(s,l)}}return r}if(null!=e){"number"==typeof e?e=DateVal.date_with_format_array(new Date(e),i.format_array):e instanceof Date&&(e=DateVal.date_with_format_array(e,i.format_array));var d=DateVal.date(i.format_string,{emit:DateVal.EMIT_COMPONENT_ARRAY}).check(e,function(e){as_components=e});if(d)return void console.error("Invalid format passed to .val of FVDateField");for(var o=0;o<i.format_array.length;o++){var n=i.format_array[o],l=DateVal.date_components[n];if(0===l)r+=n;else{var a=i.inputs[o];a.val(as_components[o])}}t.ignore_change||i.did_change(t)}return i},fieldval_ui_extend(FVBooleanField,FVField),FVBooleanField.prototype.disable=function(){var e=this;return e.input.attr("disabled","disabled"),FVField.prototype.disable.call(this)},FVBooleanField.prototype.enable=function(){var e=this;return e.input.attr("disabled",null),FVField.prototype.enable.call(this)},FVBooleanField.prototype.focus=function(){var e=this;return e.input.focus(),e},FVBooleanField.prototype.blur=function(){var e=this;return e.input.blur(),e},FVBooleanField.prototype.val=function(e,t){var i=this;return t=t||{},0===arguments.length?i.input.is(":checked"):("true"===e?e=!0:"false"===e&&(e=!1),i.input.prop("checked",e),t.ignore_change||i.did_change(t),i)},fieldval_ui_extend(FVObjectField,FVField),FVObjectField.prototype.init=function(){var e=this;for(var t in e.fields)if(e.fields.hasOwnProperty(t)){var i=e.fields[t];i.init()}},FVObjectField.prototype.remove=function(e){var t=this;for(var i in t.fields)if(t.fields.hasOwnProperty(i)){var r=t.fields[i];r.remove()}FVField.prototype.remove.call(this,e)},FVObjectField.prototype.add_field=function(e,t){var i=this;return t.element.appendTo(i.fields_element),i.fields[e]=t,t.parent=i,i},FVObjectField.prototype.remove_field=function(e){var t,i,r=this;if("string"==typeof e)t=r.fields[e],i=e;else{if(!(e instanceof FVField))throw new Error("FVObjectField.remove_field only accepts strings or FVField instances");for(var o in r.fields)r.fields.hasOwnProperty(o)&&r.fields[o]===e&&(t=r.fields[o],i=o)}t&&(t.remove(!0),delete r.fields[i])},FVObjectField.prototype.change_name=function(e){var t=this;return FVObjectField.superClass.change_name.call(this,e),t},FVObjectField.prototype.disable=function(){var e=this;for(var t in e.fields)if(e.fields.hasOwnProperty(t)){var i=e.fields[t];i.disable()}return FVField.prototype.disable.call(this)},FVObjectField.prototype.enable=function(){var e=this;for(var t in e.fields)if(e.fields.hasOwnProperty(t)){var i=e.fields[t];i.enable()}return FVField.prototype.enable.call(this)},FVObjectField.prototype.focus=function(){var e=this;return e},FVObjectField.prototype.blur=function(){var e=this;for(var t in e.fields)if(e.fields.hasOwnProperty(t)){var i=e.fields[t];i.blur()}return e},FVObjectField.prototype.error=function(e){var t=this;if(FVObjectField.superClass.error.call(this,e),t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(5===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var i=$("<ul />"),r=0;r<e.errors.length;r++){var o=e.errors[r];5===o.error?t.fields_error(o):i.append($("<li />").text(o.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},FVObjectField.prototype.fields_error=function(e){var t=this;if(e){var i=e.invalid||{},r=e.missing||{},o=e.unrecognized||{};for(var n in t.fields)if(t.fields.hasOwnProperty(n)){var l=t.fields[n],a=i[n]||r[n]||o[n]||null;l.error(a)}}else for(var n in t.fields)if(t.fields.hasOwnProperty(n)){var l=t.fields[n];l.error(null)}},FVObjectField.prototype.clear_errors=function(){var e=this;e.error(null)},FVObjectField.prototype.val=function(e,t){var i=this;if(t=t||{},0===arguments.length){var r={};for(var o in i.fields)if(i.fields.hasOwnProperty(o)){var n=i.fields[o];if(n.output_flag!==!1){var l=n.val();null!=l&&(r[o]=l)}}return r}t.ignore_parent_change=!0;for(var o in e){var n=i.fields[o];n&&n.val(e[o],t)}return t.ignore_change||i.did_change(t),i},function(e,t,i,r){function o(t,r){this.w=e(i),this.el=e(t),this.options=e.extend({},a,r),this.init()}var n="ontouchstart"in i,l=function(){var e=i.createElement("div"),r=i.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",r.appendChild(e);var o=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return r.removeChild(e),!!o}(),a={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",placeClass:"dd-placeholder",threshold:20};o.prototype={init:function(){var i=this;i.reset(),i.placeEl=e('<div class="'+i.options.placeClass+'"/>'),e.each(this.el.find(i.options.itemNodeName),function(t,r){i.setParent(e(r))});var r=function(t){var r=e(t.target);if(!r.hasClass(i.options.handleClass)){if(r.closest("."+i.options.noDragClass).length)return;r=r.closest("."+i.options.handleClass)}r.length&&!i.dragEl&&(i.isTouch=/^touch/.test(t.type),i.isTouch&&1!==t.touches.length||(t.preventDefault(),i.dragStart(t.touches?t.touches[0]:t)))},o=function(e){i.dragEl&&(e.preventDefault(),i.dragMove(e.touches?e.touches[0]:e))},l=function(e){i.dragEl&&(e.preventDefault(),i.dragStop(e.touches?e.touches[0]:e))};n&&(i.el[0].addEventListener("touchstart",r,!1),t.addEventListener("touchmove",o,!1),t.addEventListener("touchend",l,!1),t.addEventListener("touchcancel",l,!1)),i.el.on("mousedown",r),i.w.on("mousemove",o),i.w.on("mouseup",l)},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.hasNewRoot=!1,this.pointEl=null},setParent:function(e){e.children('[data-action="expand"]').hide()},unsetParent:function(e){e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var o=this.mouse,n=e(t.target),l=n.closest(this.options.itemNodeName);this.placeEl.css("height",l.height()),this.placeEl.css("width",l.width()),this.placeEl.css("display",l.css("display")),o.offsetX=t.offsetX!==r?t.offsetX:t.pageX-n.offset().left,o.offsetY=t.offsetY!==r?t.offsetY:t.pageY-n.offset().top,o.startX=o.lastX=t.pageX,o.startY=o.lastY=t.pageY,this.dragRootEl=this.el,this.el_offset=this.el.offset(),this.dragEl=e(i.createElement(this.options.listNodeName)).addClass(this.options.dragClass),this.dragEl.css("width",l.width()),l.after(this.placeEl),l[0].parentNode.removeChild(l[0]),l.appendTo(this.dragEl),e(this.el).append(this.dragEl),this.dragEl.css({left:t.pageX-o.offsetX-this.el_offset.left,top:t.pageY-o.offsetY-this.el_offset.top})},dragStop:function(){var e=this.dragEl.children(this.options.itemNodeName).first();e[0].parentNode.removeChild(e[0]),this.placeEl.replaceWith(e),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(r){var o=this.options,n=this.mouse;this.dragEl.css({left:r.pageX-n.offsetX-this.el_offset.left,top:r.pageY-n.offsetY-this.el_offset.top}),n.lastX=n.nowX,n.lastY=n.nowY,n.nowX=r.pageX,n.nowY=r.pageY,n.distX=n.nowX-n.lastX,n.distY=n.nowY-n.lastY,n.lastDirX=n.dirX,n.lastDirY=n.dirY,n.dirX=0===n.distX?0:n.distX>0?1:-1,n.dirY=0===n.distY?0:n.distY>0?1:-1;var a=Math.abs(n.distX)>Math.abs(n.distY)?1:0;if(!n.moving)return n.dirAx=a,void(n.moving=!0);n.dirAx!==a?(n.distAxX=0,n.distAxY=0):(n.distAxX+=Math.abs(n.distX),0!==n.dirX&&n.dirX!==n.lastDirX&&(n.distAxX=0),n.distAxY+=Math.abs(n.distY),0!==n.dirY&&n.dirY!==n.lastDirY&&(n.distAxY=0)),n.dirAx=a;if(l||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(i.elementFromPoint(r.pageX-i.body.scrollLeft,r.pageY-(t.pageYOffset||i.documentElement.scrollTop))),this.pointEl.hasClass(o.itemClass)||(this.pointEl=this.pointEl.closest("."+o.itemClass)),l||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(o.handleClass))this.pointEl=this.pointEl.closest("."+o.itemClass);else if(!this.pointEl.length||!this.pointEl.hasClass(o.itemClass))return;var s=this.pointEl.closest("."+o.rootClass);if(this.el[0]===s[0]){var d=(r.pageY-this.pointEl.offset().top,r.pageY-this.pointEl.offset().top,r.pageX<this.pointEl.offset().left+this.pointEl.width()/2),p=r.pageY<this.pointEl.offset().top+this.pointEl.height()/2;"block"===this.pointEl.css("display")?p?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl):p&&d?this.pointEl.before(this.placeEl):p||d||this.pointEl.after(this.placeEl)}}},e.fn.nestable=function(t){var i=this,r=this;return i.each(function(){var i=e(this).data("nestable");i?"string"==typeof t&&"function"==typeof i[t]&&(r=i[t]()):(e(this).data("nestable",new o(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),r||i}}(window.jQuery||window.Zepto,window,document),fieldval_ui_extend(FVArrayField,FVField),FVArrayField.prototype.reorder=function(){var e=this;e.fields=[];for(var t=e.fields_element.children(),i=0;i<t.length;i++){var r=$(t[i]),o=r.data("field");e.fields.push(o)}},FVArrayField.prototype.create_add_field_button=function(){var e=this,t=$("<button/>",{type:"button"}).addClass("fv_add_field_button").text(e.add_button_text).on(FVForm.button_event,function(t){t.preventDefault(),e.add_field_clicked()});return e.add_field_buttons.push(t),t},FVArrayField.prototype.add_field_clicked=function(){var e=this,t=e.new_field(e.fields.length);t&&-1===e.fields.indexOf(t)&&e.add_field(t)},FVArrayField.prototype.new_field=function(){throw new Error("FVArrayField.new_field must be overriden to create fields")},FVArrayField.prototype.add_field=function(e){var t=this;2===arguments.length&&(e=arguments[1]),e.in_array(t,function(){t.remove_field(e)}),e.element.appendTo(t.fields_element),t.fields.push(e),e.parent=t,t.input_holder.nestable("init"),t.is_disabled&&e.disable()},FVArrayField.prototype.remove_field=function(e){var t,i,r=this;if("number"==typeof e&&e%1===0&&e>=0)i=e,t=r.fields[e];else{if(!(e instanceof FVField))throw new Error("FVArrayField.remove_field only accepts non-negative integers or FVField instances");for(var o in r.fields)if(r.fields.hasOwnProperty(o)&&r.fields[o]===e){i=o,t=r.fields[o];break}}t&&(t.remove(!0),r.fields.splice(i,1))},FVArrayField.prototype.error=function(e){FVArrayField.superClass.error.call(this,e)},FVArrayField.prototype.fields_error=function(e){var t=this;if(e)for(var i=e.invalid||{},r=e.missing||{},o=e.unrecognized||{},n=0;n<t.fields.length;n++){var l=t.fields[n],a=i[n]||r[n]||o[n]||null;l.error(a)}else for(var n in t.fields){var l=t.fields[n];l.error(null)}},FVArrayField.prototype.clear_errors=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.clear_errors()}},FVArrayField.prototype.disable=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.disable()}for(var t=0;t<e.add_field_buttons.length;t++){var r=e.add_field_buttons[t];r.hide()}return FVField.prototype.disable.call(this)},FVArrayField.prototype.enable=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.enable()}for(var t=0;t<e.add_field_buttons.length;t++){var r=e.add_field_buttons[t];r.show()}return FVField.prototype.enable.call(this)},FVArrayField.prototype.error=function(e){var t=this;if(t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(5===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var i=$("<ul />"),r=0;r<e.errors.length;r++){var o=e.errors[r];5===o.error?t.fields_error(o):i.append($("<li />").text(o.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},FVArrayField.prototype.val=function(e,t){var i=this;if(t=t||{},0===arguments.length){for(var r=[],o=0;o<i.fields.length;o++){var n=i.fields[o],l=n.val();r.push(l)}return r}if(e){t.ignore_parent_change=!0;for(var o=0;o<e.length;o++){var n=i.fields[o];n||(n=i.new_field(o),n&&-1===i.fields.indexOf(n)&&i.add_field(n)),n||(n=i.fields[o]),n.val(e[o],t)}t.ignore_change||i.did_change(t)}return i},fieldval_ui_extend(FVKeyValueField,FVField),FVKeyValueField.prototype.create_add_field_button=function(){var e=this,t=$("<button />",{type:"button"}).addClass("fv_add_field_button").text(e.add_button_text).on(FVForm.button_event,function(t){t.preventDefault(),e.add_field_clicked()});return e.add_field_buttons.push(t),t},FVKeyValueField.prototype.add_field_clicked=function(){var e=this,t=e.new_field(e.fields.length);t&&-1===e.fields.indexOf(t)&&e.add_field(t)},FVKeyValueField.prototype.new_field=function(){throw new Error("FVKeyValueField.new_field must be overriden to create fields")},FVKeyValueField.prototype.add_field=function(e){var t=this;2===arguments.length&&(e=arguments[1]),e.in_key_value(t,function(i){t.remove_field(e,i)}),e.element.appendTo(t.fields_element),t.fields.push(e),e.parent=t,e.name_val(""),t.is_disabled&&e.disable()},FVKeyValueField.prototype.change_key_name=function(e,t,i){var r=this;if(void 0!==e){var o=r.keys[e];if(o!==i)throw new Error("Old key name does not match this field ",e);delete r.keys[e]}null===t&&(t="");for(var n=t,l=2;void 0!==r.keys[n];)n=t+"_"+l++;return r.keys[n]=i,n},FVKeyValueField.prototype.remove_field=function(e){var t,i,r=this;
if("string"==typeof e){for(var o=0;o<r.fields.length;o++)if(r.fields[o].name_val()===e){t=r.fields[o],i=o;break}}else{if(!(e instanceof FVField))throw new Error("FVKeyValueField.remove_field only accepts strings or FVField instances");for(var o=0;o<r.fields.length;o++)if(r.fields.hasOwnProperty(o)&&r.fields[o]===e){t=r.fields[o],i=o;break}}t&&(t.remove(!0),r.fields.splice(i,1),delete r.keys[t.key_name])},FVKeyValueField.prototype.error=function(e){FVKeyValueField.superClass.error.call(this,e)},FVKeyValueField.prototype.fields_error=function(e){var t=this;if(e){var i=e.invalid||{},r=e.missing||{},o=e.unrecognized||{};for(var n in t.keys)if(t.keys.hasOwnProperty(n)){var l=t.keys[n],a=i[n]||r[n]||o[n]||null;l.error(a)}}else for(var n in t.keys)if(t.keys.hasOwnProperty(n)){var l=t.keys[n];l.error(null)}},FVKeyValueField.prototype.clear_errors=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.clear_errors()}},FVKeyValueField.prototype.disable=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.disable()}for(var t=0;t<e.add_field_buttons.length;t++){var r=e.add_field_buttons[t];r.hide()}return FVField.prototype.disable.call(this)},FVKeyValueField.prototype.enable=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.enable()}for(var t=0;t<e.add_field_buttons.length;t++){var r=e.add_field_buttons[t];r.show()}return FVField.prototype.enable.call(this)},FVKeyValueField.prototype.error=function(e){var t=this;if(t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(5===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var i=$("<ul />"),r=0;r<e.errors.length;r++){var o=e.errors[r];5===o.error?t.fields_error(o):i.append($("<li />").text(o.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},FVKeyValueField.prototype.val=function(e,t){var i=this;if(t=t||{},0===arguments.length){var r={};for(var o in i.keys)if(i.keys.hasOwnProperty(o)){var n=i.keys[o];if(n.output_flag!==!1){var l=n.val();r[o]=l}}return r}if(t.ignore_parent_change=!0,e){for(var o in i.keys)if(i.keys.hasOwnProperty(o)&&void 0===e[o]){var n=i.keys[o];i.remove_field(n)}for(var o in e)if(e.hasOwnProperty(o)){var n=i.keys[o];n||(n=i.new_field(o),n&&-1===i.fields.indexOf(n)&&i.add_field(n)),n.val(e[o],t),n.name_val(o)}}return t.ignore_change||i.did_change(t),i},"function"!=typeof Object.getPrototypeOf&&(Object.getPrototypeOf="object"==typeof"test".__proto__?function(e){return e.__proto__}:function(e){return e.constructor.prototype}),fieldval_ui_extend(FVProxyField,FVField),FVProxyField.prototype.init=function(){var e=this;e.init_called=!0,e.inner_field&&e.inner_field.init()},FVProxyField.prototype.replace=function(e,t){var i=this;t=t||{},i.inner_field=e,i.init_called&&i.inner_field.init();var r=[],o=[],n=!1;i.element.children().each(function(e,t){t===i.title[0]?n=!0:t!==i.input_holder[0]&&t!==i.error_message[0]&&(n?o.push(t):r.push(t))}),i.element.replaceWith(i.inner_field.element),i.element=i.inner_field.element,i.element.prepend(r),i.element.append(o),void 0!==i.last_val&&i.inner_field.val(i.last_val);for(var l=["output_flag","is_in_array","key_value_parent","is_in_key_value","key_name","is_disabled"],a=0;a<l.length;a++)e[l[a]]=i[l[a]];for(var s=[],d=0;d<i.on_change_callbacks.length;d++)s.push(i.on_change_callbacks[d]);var p=[];if(void 0!==i.on_submit_callbacks)for(var d=0;d<i.on_submit_callbacks.length;d++)p.push(i.on_submit_callbacks[d]);var u=Object.getPrototypeOf(e);for(var _ in u)u.hasOwnProperty(_)&&(i[_]=u[_]);for(var _ in e)e.hasOwnProperty(_)&&(i[_]=e[_]);for(var d=0;d<s.length;d++)i.on_change_callbacks.push(s[d]);if(void 0!==i.on_submit_callbacks)for(var d=0;d<p.length;d++)i.on_submit_callbacks.push(p[d]);i.is_in_key_value&&(i.in_key_value(i.key_value_parent,i.key_value_remove_callback),i.name_input.val(i.key_name)),i.is_in_array&&i.in_array(i.array_parent,i.array_remove_callback),i.is_disabled&&i.disable();for(var _=0;_<i.on_replace_callbacks.length;_++)i.on_replace_callbacks[_]();t.ignore_change||i.did_change(t)},FVProxyField.prototype.on_replace=function(e){var t=this;return t.on_replace_callbacks.push(e),t},FVProxyField.prototype.val=function(e,t){var i=this;return t=t||{},i.inner_field?i.inner_field.val.apply(i.inner_field,arguments):void(0!==arguments.length&&(i.last_val=e,t.ignore_change||i.did_change(t)))},fieldval_ui_extend(FVForm,FVObjectField),FVForm.button_event="click",FVForm.is_mobile=/android|webos|iphone|ipad|ipod|blackberry|iemobile|nokia|series40|x11|opera mini/i.test(navigator.userAgent.toLowerCase()),($.fn.tap||$.tap)&&(FVForm.button_event="tap");