function fieldval_ui_extend(e,t){function i(){}i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e,e.superConstructor=t,e.superClass=t.prototype}function FVField(e,t){var i=this;i.name=e,i.options=t||{},i.output_flag=!0,i.is_in_array=!1,i.key_value_parent=null,i.is_in_key_value=!1,i.is_disabled=!1,i.on_change_callbacks=[],i.element=$("<div />").addClass("fv_field").data("field",i),i.title=$("<div />").addClass("fv_field_title").text(i.name),i.name||i.title.hide(),i.options.description&&(i.description_label=$("<div />").addClass("fv_field_description").text(i.options.description)),i.input_holder=$("<div />").addClass("fv_input_holder"),i.error_message=$("<div />").addClass("fv_error_message").hide(),i.layout()}function FVTextField(e,t){var i=this,o=typeof t;"string"===o?(i.input_type=t,t={}):"object"===o?i.input_type=t.type||"text":t={},FVTextField.superConstructor.call(this,e,t),i.element.addClass("fv_text_field"),i.input=$("textarea"===i.input_type?"<textarea />":"text"!==i.input_type&&"number"!==i.input_type&&i.input_type?"<input type='"+i.input_type+"' />":"<input type='text' />"),i.enter_callbacks=[],i.previous_value={},i.input.addClass("fv_text_input").attr("placeholder",e).on("keydown",function(e){if(13===e.keyCode)for(var t=0;t<i.enter_callbacks.length;t++)i.enter_callbacks[t](e)}).on("keyup paste cut",function(){setTimeout(function(){i.check_changed()},0)}).appendTo(i.input_holder)}function FVPasswordField(e){FVPasswordField.superConstructor.call(this,e,{type:"password"})}function FVDisplayField(e,t){var i=this;FVDisplayField.superConstructor.call(this,e,t),i.element.addClass("fv_display_field"),i.input=$("<div />").appendTo(i.input_holder),i.output_flag=!1}function FVChoiceField(e,t){var i=this;FVChoiceField.superConstructor.call(this,e,t),i.choices=i.options.choices||[],i.allow_empty=i.options.allow_empty||!1,i.empty_text=i.options.empty_text||"",i.choice_values=[],i.choice_texts=[],i.selected_value=null,i.allow_empty&&(i.choice_values.push(null),i.choice_texts.push(i.empty_text));for(var o=0;o<i.choices.length;o++){var r,l,s=i.choices[o];"object"==typeof s?(r=s[0],l=s[1]):r=l=s,i.choice_values.push(r),i.choice_texts.push(l)}i.element.addClass("fv_choice_field"),i.select=$("<div/>").append(i.filter_input=$("<input type='text' />").attr("placeholder",e).addClass("filter_input"),i.current_display=$("<div />").addClass("fv_choice_display fv_choice_placeholder").on(FVForm.button_event,function(){i.focus()}).text(i.name),i.choice_list=$("<div />").addClass("fv_choice_list").bind("mousewheel DOMMouseScroll",function(e){var t=null;"mousewheel"==e.type?t=e.originalEvent.wheelDelta*-.5:"DOMMouseScroll"==e.type&&(t=40*e.originalEvent.detail),t&&(e.preventDefault(),$(this).scrollTop(t+$(this).scrollTop()))})).addClass("fv_choice_input").appendTo(i.input_holder),i.filter_input.hide().on("keydown",function(e){(38===e.keyCode||40===e.keyCode||13===e.keyCode)&&e.preventDefault()}).on("keyup",function(e){return 40===e.keyCode?(i.move_down(),void e.preventDefault()):38===e.keyCode?(i.move_up(),void e.preventDefault()):13===e.keyCode?(i.select_highlighted(),void e.preventDefault()):(27===e.keyCode&&(i.hide_list(),e.preventDefault()),void i.filter(i.filter_input.val()))}),$("html").on(FVForm.button_event,function(e){i.filter_input.is(":visible")&&($(e.target).closest(i.filter_input).length||i.hide_list())}),i.filter("")}function FVDateField(e,t){var i=this;if("undefined"==typeof DateVal)return void console.error("FVDateField requires fieldval-dateval-js");FVDateField.superConstructor.call(this,e,t),i.element.addClass("fv_date_field"),i.format_string=i.options.format||"yyyy-MM-dd";var o=DateVal.date_format().check(i.format_string,function(e){i.format_array=e});if(o)return void console.error(o.error_message);i.inputs=[];for(var r=0;r<i.format_array.length;r++){var l=i.format_array[r],s=DateVal.date_components[l];i.add_element_from_component(l,s)}}function FVBooleanField(e,t){var i=this;FVBooleanField.superConstructor.call(this,e,t),i.element.addClass("fv_boolean_field"),i.input=$("<input type='checkbox' />").addClass("fv_boolean_input").on("change",function(){i.did_change()}).appendTo(i.input_holder)}function FVObjectField(e,t){var i=this;FVObjectField.superConstructor.call(this,e,t),i.element.addClass("fv_object_field"),i.fields_element=i.input_holder,i.fields={}}function FVArrayField(e,t){var i=this;FVArrayField.superConstructor.call(this,e,t),i.fields=[],i.add_field_buttons=[],i.element.addClass("fv_array_field"),i.input_holder.append(i.fields_element=$("<div />").addClass("fv_nested_fields"),i.create_add_field_button()),i.input_holder.nestable({rootClass:"fv_input_holder",itemClass:"fv_field",handleClass:"fv_field_move_handle",itemNodeName:"div.fv_field",listNodeName:"div.fv_nested_fields",collapseBtnHTML:"",expandBtnHTML:"",maxDepth:1}).on("change",function(){i.reorder()})}function FVKeyValueField(e,t){var i=this;FVKeyValueField.superConstructor.call(this,e,t),i.fields=[],i.keys={},i.add_field_buttons=[],i.element.addClass("fv_key_value_field"),i.input_holder.append(i.fields_element=$("<div />").addClass("fv_nested_fields"),i.create_add_field_button())}function FVForm(){var e=this;FVForm.superConstructor.call(this);var t=e.element.children();e.element.remove(),e.element=$("<form />").addClass("fv_form").append(t),e.element.on("submit",function(t){return t.preventDefault(),e.submit(),!1}),e.fields_element=e.element,e.submit_callbacks=[]}FVField.prototype.in_array=function(e){var t=this;t.is_in_array=!0,t.element.addClass("fv_in_array").append(t.move_handle=$("<div />").addClass("fv_field_move_handle"),t.remove_button=$("<button />").addClass("fv_field_remove_button").html("&#10006;").on(FVForm.button_event,function(i){i.preventDefault(),e(),t.remove()}))},FVField.prototype.in_key_value=function(e,t){var i=this;i.key_value_parent=e,i.is_in_key_value=!0,i.name_input=new FVTextField("Key").on_change(function(e){i.key_name=i.key_value_parent.change_key_name(i.key_name,e,i)}),i.name_input.element.addClass("fv_key_value_name_input"),i.title.replaceWith(i.name_input.element),i.element.addClass("fv_in_key_value").append(i.remove_button=$("<button />").addClass("fv_field_remove_button").html("&#10006;").on(FVForm.button_event,function(e){e.preventDefault(),t(),i.remove()}))},FVField.prototype.init=function(){},FVField.prototype.remove=function(){var e=this;e.element.remove()},FVField.prototype.change_name=function(e){var t=this;return t.name=e,t},FVField.prototype.layout=function(){var e=this;e.element.append(e.title,e.description_label,e.input_holder,e.error_message)},FVField.prototype.on_change=function(e){var t=this;return t.on_change_callbacks.push(e),t},FVField.prototype.output=function(e){var t=this;return t.output_flag=e,t},FVField.prototype.did_change=function(){for(var e=this,t=e.val(),i=0;i<e.on_change_callbacks.length;i++){var o=e.on_change_callbacks[i];o(t)}return e},FVField.prototype.icon=function(){},FVField.prototype.val=function(){console.error("Did not override FVField.val()")},FVField.prototype.disable=function(){var e=this;return e.is_disabled=!0,e.element.addClass("fv_disabled"),e.is_in_array&&(e.move_handle.hide(),e.remove_button.hide()),e},FVField.prototype.enable=function(){var e=this;return e.is_disabled=!1,e.element.removeClass("fv_disabled"),e.is_in_array&&(e.move_handle.show(),e.remove_button.show()),e},FVField.prototype.blur=function(){},FVField.prototype.focus=function(){},FVField.prototype.show_error=function(){var e=this;e.error_message.show()},FVField.prototype.hide_error=function(){var e=this;e.error_message.hide()},FVField.prototype.name_val=function(){var e=this,t=e.name_input.val.apply(e.name_input,arguments);return e.key_name=e.key_value_parent.change_key_name(e.key_name,e.name_input.val(),e),t},FVField.prototype.error=function(e){var t=this;if(e){if(t.error_message.empty(),4===e.error){for(var i=$("<ul />"),o=0;o<e.errors.length;o++){var r=e.errors[o];i.append($("<li />").text(r.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.element&&t.element.addClass("fv_field_error"),t.show_error()}else t.hide_error(),t.element&&t.element.removeClass("fv_field_error")},fieldval_ui_extend(FVTextField,FVField),FVTextField.prototype.check_changed=function(){var e=this,t=e.val();t!==e.previous_value&&(e.previous_value=t,e.did_change())},FVTextField.prototype.on_enter=function(e){var t=this;return t.enter_callbacks.push(e),t},FVTextField.prototype.icon=function(e){var t=this,i={"background-image":"url("+e.background+")","background-position":e.position,"background-repeat":"no-repeat","padding-left":e.width+"px"};return t.input.css(i),t},FVTextField.prototype.change_name=function(e){var t=this;return FVTextField.superClass.change_name.call(this,e),t.input.attr("placeholder",e),t},FVTextField.prototype.disable=function(){var e=this;return e.input.attr("disabled","disabled"),FVField.prototype.disable.call(this)},FVTextField.prototype.enable=function(){var e=this;return e.input.attr("disabled",null),FVField.prototype.enable.call(this)},FVTextField.prototype.focus=function(){var e=this;return e.input.focus(),e},FVTextField.prototype.blur=function(){var e=this;return e.input.blur(),e},FVTextField.numeric_regex=/^\d+(\.\d+)?$/,FVTextField.prototype.val=function(e){var t=this;if(0===arguments.length){var i=t.input.val();return"number"===t.input_type&&FVTextField.numeric_regex.test(i)?parseFloat(i):0===i.length?null:i}return t.input.val(e),t},fieldval_ui_extend(FVPasswordField,FVTextField),fieldval_ui_extend(FVDisplayField,FVField),FVDisplayField.prototype.icon=function(e){var t=this,i={"background-image":"url("+e.background+")","background-position":e.position,"background-repeat":"no-repeat","padding-left":e.width+"px"};return t.input.css(i),t},FVDisplayField.replace_line_breaks=function(e){if("string"!=typeof e)return e;for(var t=[],i=e.split(/\n/),o=jQuery(document.createElement("div")),r=0;r<i.length;r++)t.push(o.text(i[r]).html());return t.join("<br>")},FVDisplayField.prototype.val=function(e){var t=this;return 0===arguments.length?t.input.text():(t.input.html(FVDisplayField.replace_line_breaks(e)),t)},fieldval_ui_extend(FVChoiceField,FVField),FVChoiceField.prototype.show_list=function(){var e=this;e.is_disabled||(e.input_holder.css("min-height",e.current_display.outerHeight()+"px"),e.filter_input.show(),e.current_display.hide(),FVForm.is_mobile||e.filter_input.focus(),e.choice_list.show(),e.current_highlight=null,e.filter("",!0))},FVChoiceField.prototype.hide_list=function(){var e=this;e.input_holder.css("min-height",""),e.filter_input.hide(),e.current_display.show(),e.choice_list.hide()},FVChoiceField.prototype.filter=function(e,t){var i=this,o=e.toLowerCase();i.choice_list.empty();for(var r=0;r<i.choice_values.length;r++){var l=i.choice_values[r],s=i.choice_texts[r];(""===s&&""===o||0==s.toLowerCase().indexOf(o))&&i.add_option(l,s,t)}t&&i.current_highlight||(i.current_highlight=$(i.choice_list.children()[0])),i.current_highlight&&i.current_highlight.addClass("highlighted")},FVChoiceField.prototype.value_to_text=function(e){for(var t=this,i=0;i<t.choice_values.length;i++){var o=t.choice_values[i];if(o===e)return t.choice_texts[i]}return null},FVChoiceField.prototype.select_option=function(e,t){var i=this;i.selected_value=e;var o=i.value_to_text(e);i.current_display.removeClass("fv_choice_placeholder").text(o),i.hide_list(),i.filter_input.blur().hide().val(""),t||i.did_change()},FVChoiceField.prototype.move_up=function(){var e=this;if(e.current_highlight){e.current_highlight.removeClass("highlighted");var t=e.current_highlight.prev();t[0]?(e.current_highlight=t,e.current_highlight.addClass("highlighted"),e.move_into_view()):e.current_highlight=null}},FVChoiceField.prototype.move_down=function(){var e=this;if(e.current_highlight){var t=e.current_highlight.next();t[0]&&(e.current_highlight.removeClass("highlighted"),e.current_highlight=t,e.current_highlight.addClass("highlighted"),e.move_into_view())}else e.current_highlight=$(e.choice_list.children()[0]),e.current_highlight&&e.current_highlight.addClass("highlighted")},FVChoiceField.prototype.move_into_view=function(e){var t=this;void 0===e&&(e=t.current_highlight),setTimeout(function(){var i=e.offset().top;t.choice_list.scrollTop(t.choice_list.scrollTop()-t.choice_list.offset().top+i-50)},1)},FVChoiceField.prototype.add_option=function(e,t,i){var o=this,r=$("<div />").addClass("fv_choice_option").data("value",e).text(t).on(FVForm.button_event,function(t){o.default_click(t,e)});o.finalize_option(r,e,i)},FVChoiceField.prototype.default_click=function(e,t){var i=this;e.preventDefault(),e.stopPropagation(),e.originalEvent&&(e.originalEvent.preventDefault(),e.originalEvent.stopPropagation()),i.select_option(t)},FVChoiceField.prototype.finalize_option=function(e,t,i){var o=this;o.selected_value===t&&(e.addClass("selected"),o.move_into_view(e),i&&(o.current_highlight=e)),e.appendTo(o.choice_list)},FVChoiceField.prototype.select_highlighted=function(){var e=this;e.current_highlight&&e.current_highlight[0]&&e.select_option(e.current_highlight.data("value"))},FVChoiceField.prototype.focus=function(){var e=this;return e.filter_input.val(""),setTimeout(function(){e.show_list()},1),e},FVChoiceField.prototype.blur=function(){var e=this;return e.hide_list(),e},FVChoiceField.prototype.val=function(e){var t=this;return 0===arguments.length?t.selected_value:(void 0!==e&&t.select_option(e,!0),t)},fieldval_ui_extend(FVDateField,FVField),FVDateField.prototype.add_element_from_component=function(e,t){var i=this;if(0===t){var o=e;i.inputs.push(null),i.input_holder.append($("<div />").addClass("fv_date_separator").text(o))}else{var r=t[t.length-1],l=$("<input />").attr({placeholder:e,size:r,maxlength:r}).addClass("fv_date_input").on("keyup",function(){i.did_change()});l.blur(function(){var e=l.val(),i=DateVal.pad_to_valid(e,t);l.val(i)}),i.inputs.push(l),i.input_holder.append(l)}},FVDateField.prototype.icon=function(){var e=this;return e},FVDateField.prototype.change_name=function(e){var t=this;return FVDateField.superClass.change_name.call(this,e),t.input.attr("placeholder",e),t},FVDateField.prototype.disable=function(){for(var e=this,t=0;t<e.inputs.length;t++){var i=e.inputs[t];i&&i.attr("disabled","disabled")}return FVField.prototype.disable.call(this)},FVDateField.prototype.enable=function(){for(var e=this,t=0;t<e.inputs.length;t++){var i=e.inputs[t];i&&i.attr("disabled",null)}return FVField.prototype.enable.call(this)},FVDateField.prototype.focus=function(){var e=this,t=e.inputs[0];return t&&t.blur(),e},FVDateField.prototype.blur=function(){for(var e=this,t=0;t<e.inputs.length;t++){var i=e.inputs[t];i&&i.blur()}return e},FVDateField.prototype.val=function(e){var t=this;if(0===arguments.length){for(var i="",o=0;o<t.format_array.length;o++){var r=t.format_array[o],l=DateVal.date_components[r];if(0===l)i+=r;else{var s=t.inputs[o],a=s.val().toString();i+=DateVal.pad_to_valid(a,l)}}return i}if(null!=e){"number"==typeof e?e=DateVal.date_with_format_array(new Date(e),t.format_array):e instanceof Date&&(e=DateVal.date_with_format_array(e,t.format_array));var n=DateVal.date(t.format_string,{emit:DateVal.EMIT_COMPONENT_ARRAY}).check(e,function(e){as_components=e});if(n)return void console.error("Invalid format passed to .val of FVDateField");for(var o=0;o<t.format_array.length;o++){var r=t.format_array[o],l=DateVal.date_components[r];if(0===l)i+=r;else{var s=t.inputs[o];s.val(as_components[o])}}}return t},fieldval_ui_extend(FVBooleanField,FVField),FVBooleanField.prototype.disable=function(){var e=this;return e.input.attr("disabled","disabled"),FVField.prototype.disable.call(this)},FVBooleanField.prototype.enable=function(){var e=this;return e.input.attr("disabled",null),FVField.prototype.enable.call(this)},FVBooleanField.prototype.focus=function(){var e=this;return e.input.focus(),e},FVBooleanField.prototype.blur=function(){var e=this;return e.input.blur(),e},FVBooleanField.prototype.val=function(e){var t=this;return 0===arguments.length?t.input.is(":checked"):("true"===e?e=!0:"false"===e&&(e=!1),t.input.prop("checked",e),t)},fieldval_ui_extend(FVObjectField,FVField),FVObjectField.prototype.init=function(){var e=this;for(var t in e.fields){var i=e.fields[t];i.init()}},FVObjectField.prototype.remove=function(){var e=this;for(var t in e.fields){var i=e.fields[t];i.remove()}FVField.prototype.remove.call(this)},FVObjectField.prototype.add_field=function(e,t){var i=this;return t.element.appendTo(i.fields_element),i.fields[e]=t,i},FVObjectField.prototype.remove_field=function(e){var t=this,i=t.fields[e];i&&(i.remove(),delete t.fields[e])},FVObjectField.prototype.change_name=function(e){var t=this;return FVObjectField.superClass.change_name.call(this,e),t},FVObjectField.prototype.disable=function(){var e=this;for(var t in e.fields){var i=e.fields[t];i.disable()}return FVField.prototype.disable.call(this)},FVObjectField.prototype.enable=function(){var e=this;for(var t in e.fields){var i=e.fields[t];i.enable()}return FVField.prototype.enable.call(this)},FVObjectField.prototype.focus=function(){var e=this;return e},FVObjectField.prototype.blur=function(){var e=this;for(var t in e.fields){var i=e.fields[t];i.blur()}return e},FVObjectField.prototype.error=function(e){var t=this;if(FVObjectField.superClass.error.call(this,e),t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(0===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var i=$("<ul />"),o=0;o<e.errors.length;o++){var r=e.errors[o];0===r.error?t.fields_error(r):i.append($("<li />").text(r.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},FVObjectField.prototype.fields_error=function(e){var t=this;if(e){var i=e.invalid||{},o=e.missing||{},r=e.unrecognized||{};for(var l in t.fields){var s=t.fields[l],a=i[l]||o[l]||r[l]||null;s.error(a)}}else for(var l in t.fields){var s=t.fields[l];s.error(null)}},FVObjectField.prototype.clear_errors=function(){var e=this;e.error(null)},FVObjectField.prototype.val=function(e){var t=this;if(0===arguments.length){var i={};for(var o in t.fields){var r=t.fields[o];if(r.output_flag!==!1){var l=r.val();null!=l&&(i[o]=l)}}return i}for(var o in e){var r=t.fields[o];r&&r.val(e[o])}return t},function(e,t,i,o){function r(t,o){this.w=e(i),this.el=e(t),this.options=e.extend({},a,o),this.init()}var l="ontouchstart"in i,s=function(){var e=i.createElement("div"),o=i.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",o.appendChild(e);var r=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return o.removeChild(e),!!r}(),a={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};r.prototype={init:function(){var i=this;i.reset(),i.el.data("nestable-group",this.options.group),i.placeEl=e('<div class="'+i.options.placeClass+'"/>'),e.each(this.el.find(i.options.itemNodeName),function(t,o){i.setParent(e(o))}),i.el.on("click","button",function(t){if(!i.dragEl){var o=e(t.currentTarget),r=o.data("action"),l=o.parent(i.options.itemNodeName);"collapse"===r&&i.collapseItem(l),"expand"===r&&i.expandItem(l)}});var o=function(t){var o=e(t.target);if(!o.hasClass(i.options.handleClass)){if(o.closest("."+i.options.noDragClass).length)return;o=o.closest("."+i.options.handleClass)}o.length&&!i.dragEl&&(i.isTouch=/^touch/.test(t.type),i.isTouch&&1!==t.touches.length||(t.preventDefault(),i.dragStart(t.touches?t.touches[0]:t)))},r=function(e){i.dragEl&&(e.preventDefault(),i.dragMove(e.touches?e.touches[0]:e))},s=function(e){i.dragEl&&(e.preventDefault(),i.dragStop(e.touches?e.touches[0]:e))};l&&(i.el[0].addEventListener("touchstart",o,!1),t.addEventListener("touchmove",r,!1),t.addEventListener("touchend",s,!1),t.addEventListener("touchcancel",s,!1)),i.el.on("mousedown",o),i.w.on("mousemove",r),i.w.on("mouseup",s)},serialize:function(){var t,i=0,o=this;return step=function(t,i){var r=[],l=t.children(o.options.itemNodeName);return l.each(function(){var t=e(this),l=e.extend({},t.data()),s=t.children(o.options.listNodeName);s.length&&(l.children=step(s,i+1)),r.push(l)}),r},t=step(o.el.find(o.options.listNodeName).first(),i)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(e){e.removeClass(this.options.collapsedClass),e.children('[data-action="expand"]').hide(),e.children('[data-action="collapse"]').show(),e.children(this.options.listNodeName).show()},collapseItem:function(e){var t=e.children(this.options.listNodeName);t.length&&(e.addClass(this.options.collapsedClass),e.children('[data-action="collapse"]').hide(),e.children('[data-action="expand"]').show(),e.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(e(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(e(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(e(this.options.expandBtnHTML)),t.prepend(e(this.options.collapseBtnHTML))),t.children('[data-action="expand"]').hide()},unsetParent:function(e){e.removeClass(this.options.collapsedClass),e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var r=this.mouse,l=e(t.target),s=l.closest(this.options.itemNodeName);this.placeEl.css("height",s.height()),this.placeEl.css("width",s.width()),this.placeEl.css("display",s.css("display")),r.offsetX=t.offsetX!==o?t.offsetX:t.pageX-l.offset().left,r.offsetY=t.offsetY!==o?t.offsetY:t.pageY-l.offset().top,r.startX=r.lastX=t.pageX,r.startY=r.lastY=t.pageY,this.dragRootEl=this.el,this.el_offset=this.el.offset(),this.dragEl=e(i.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",s.width()),s.after(this.placeEl),s[0].parentNode.removeChild(s[0]),s.appendTo(this.dragEl),e(this.el).append(this.dragEl),this.dragEl.css({left:t.pageX-r.offsetX-this.el_offset.left,top:t.pageY-r.offsetY-this.el_offset.top});var a,n,d=this.dragEl.find(this.options.itemNodeName);for(a=0;a<d.length;a++)n=e(d[a]).parents(this.options.listNodeName).length,n>this.dragDepth&&(this.dragDepth=n)},dragStop:function(){var e=this.dragEl.children(this.options.itemNodeName).first();e[0].parentNode.removeChild(e[0]),this.placeEl.replaceWith(e),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(o){var r,l,a,n,d,p=this.options,h=this.mouse;this.dragEl.css({left:o.pageX-h.offsetX-this.el_offset.left,top:o.pageY-h.offsetY-this.el_offset.top}),h.lastX=h.nowX,h.lastY=h.nowY,h.nowX=o.pageX,h.nowY=o.pageY,h.distX=h.nowX-h.lastX,h.distY=h.nowY-h.lastY,h.lastDirX=h.dirX,h.lastDirY=h.dirY,h.dirX=0===h.distX?0:h.distX>0?1:-1,h.dirY=0===h.distY?0:h.distY>0?1:-1;var u=Math.abs(h.distX)>Math.abs(h.distY)?1:0;if(!h.moving)return h.dirAx=u,void(h.moving=!0);h.dirAx!==u?(h.distAxX=0,h.distAxY=0):(h.distAxX+=Math.abs(h.distX),0!==h.dirX&&h.dirX!==h.lastDirX&&(h.distAxX=0),h.distAxY+=Math.abs(h.distY),0!==h.dirY&&h.dirY!==h.lastDirY&&(h.distAxY=0)),h.dirAx=u,h.dirAx&&h.distAxX>=p.threshold&&(h.distAxX=0,a=this.placeEl.prev(p.itemNodeName),h.distX>0&&a.length&&!a.hasClass(p.collapsedClass)&&(r=a.find(p.listNodeName).last(),d=this.placeEl.parents(p.listNodeName).length,d+this.dragDepth<=p.maxDepth&&(r.length?(r=a.children(p.listNodeName).last(),r.append(this.placeEl)):(r=e("<"+p.listNodeName+"/>").addClass(p.listClass),r.append(this.placeEl),a.append(r),this.setParent(a)))),h.distX<0&&(n=this.placeEl.next(p.itemNodeName),n.length||(l=this.placeEl.parent(),this.placeEl.closest(p.itemNodeName).after(this.placeEl),l.children().length||this.unsetParent(l.parent()))));var c=!1;if(s||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(i.elementFromPoint(o.pageX-i.body.scrollLeft,o.pageY-(t.pageYOffset||i.documentElement.scrollTop))),s||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(p.handleClass)&&(this.pointEl=this.pointEl.closest("."+p.itemClass)),this.pointEl.hasClass(p.emptyClass))c=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(p.itemClass))return;var f=this.pointEl.closest("."+p.rootClass),v=this.dragRootEl.data("nestable-id")!==f.data("nestable-id");if(!h.dirAx||v||c){if(v&&p.group!==f.data("nestable-group"))return;if(d=this.dragDepth-1+this.pointEl.parents(p.listNodeName).length,d>p.maxDepth)return;var _=o.pageY<this.pointEl.offset().top+this.pointEl.height()/2;l=this.placeEl.parent(),c?(r=e(i.createElement(p.listNodeName)).addClass(p.listClass),r.append(this.placeEl),this.pointEl.replaceWith(r)):_?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),l.children().length||this.unsetParent(l.parent()),this.dragRootEl.find(p.itemNodeName).length||this.dragRootEl.append('<div class="'+p.emptyClass+'"/>'),v&&(this.dragRootEl=f,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},e.fn.nestable=function(t){var i=this,o=this;return i.each(function(){var i=e(this).data("nestable");i?"string"==typeof t&&"function"==typeof i[t]&&(o=i[t]()):(e(this).data("nestable",new r(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),o||i}}(window.jQuery||window.Zepto,window,document),fieldval_ui_extend(FVArrayField,FVField),FVArrayField.prototype.reorder=function(){var e=this;e.fields=[];for(var t=e.fields_element.children(),i=0;i<t.length;i++){var o=$(t[i]),r=o.data("field");e.fields.push(r)}},FVArrayField.prototype.create_add_field_button=function(){var e=this,t=$("<button />").addClass("fv_add_field_button").text("+").on(FVForm.button_event,function(t){t.preventDefault(),e.new_field(e.fields.length)});return e.add_field_buttons.push(t),t},FVArrayField.prototype.new_field=function(){throw new Error("FVArrayField.new_field must be overriden to create fields")},FVArrayField.prototype.add_field=function(e,t){var i=this;t.in_array(function(){i.remove_field(t)}),t.element.appendTo(i.fields_element),i.fields.push(t),i.input_holder.nestable("init"),i.is_disabled&&t.disable()},FVArrayField.prototype.remove_field=function(e){for(var t=this,i=0;i<t.fields.length;i++)t.fields[i]===e&&t.fields.splice(i,1)},FVArrayField.prototype.error=function(e){FVArrayField.superClass.error.call(this,e)},FVArrayField.prototype.fields_error=function(e){var t=this;if(e)for(var i=e.invalid||{},o=e.missing||{},r=e.unrecognized||{},l=0;l<t.fields.length;l++){var s=t.fields[l],a=i[l]||o[l]||r[l]||null;s.error(a)}else for(var l in t.fields){var s=t.fields[l];s.error(null)}},FVArrayField.prototype.clear_errors=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.clear_errors()}},FVArrayField.prototype.disable=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.disable()}for(var t=0;t<e.add_field_buttons.length;t++){var o=e.add_field_buttons[t];o.hide()}return FVField.prototype.disable.call(this)},FVArrayField.prototype.enable=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.enable()}for(var t=0;t<e.add_field_buttons.length;t++){var o=e.add_field_buttons[t];o.show()}return FVField.prototype.enable.call(this)},FVArrayField.prototype.error=function(e){var t=this;if(t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(0===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var i=$("<ul />"),o=0;o<e.errors.length;o++){var r=e.errors[o];0===r.error?t.fields_error(r):i.append($("<li />").text(r.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},FVArrayField.prototype.val=function(e){var t=this;if(0===arguments.length){for(var i=[],o=0;o<t.fields.length;o++){var r=t.fields[o],l=r.val();i.push(l)}return i}if(e)for(var o=0;o<e.length;o++){var r=t.fields[o];r||(r=t.new_field(o)),r.val(e[o])}return t},function(e,t,i,o){function r(t,o){this.w=e(i),this.el=e(t),this.options=e.extend({},a,o),this.init()}var l="ontouchstart"in i,s=function(){var e=i.createElement("div"),o=i.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",o.appendChild(e);var r=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return o.removeChild(e),!!r}(),a={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};r.prototype={init:function(){var i=this;i.reset(),i.el.data("nestable-group",this.options.group),i.placeEl=e('<div class="'+i.options.placeClass+'"/>'),e.each(this.el.find(i.options.itemNodeName),function(t,o){i.setParent(e(o))}),i.el.on("click","button",function(t){if(!i.dragEl){var o=e(t.currentTarget),r=o.data("action"),l=o.parent(i.options.itemNodeName);"collapse"===r&&i.collapseItem(l),"expand"===r&&i.expandItem(l)}});var o=function(t){var o=e(t.target);if(!o.hasClass(i.options.handleClass)){if(o.closest("."+i.options.noDragClass).length)return;o=o.closest("."+i.options.handleClass)}o.length&&!i.dragEl&&(i.isTouch=/^touch/.test(t.type),i.isTouch&&1!==t.touches.length||(t.preventDefault(),i.dragStart(t.touches?t.touches[0]:t)))},r=function(e){i.dragEl&&(e.preventDefault(),i.dragMove(e.touches?e.touches[0]:e))},s=function(e){i.dragEl&&(e.preventDefault(),i.dragStop(e.touches?e.touches[0]:e))};l&&(i.el[0].addEventListener("touchstart",o,!1),t.addEventListener("touchmove",r,!1),t.addEventListener("touchend",s,!1),t.addEventListener("touchcancel",s,!1)),i.el.on("mousedown",o),i.w.on("mousemove",r),i.w.on("mouseup",s)},serialize:function(){var t,i=0,o=this;return step=function(t,i){var r=[],l=t.children(o.options.itemNodeName);return l.each(function(){var t=e(this),l=e.extend({},t.data()),s=t.children(o.options.listNodeName);s.length&&(l.children=step(s,i+1)),r.push(l)}),r},t=step(o.el.find(o.options.listNodeName).first(),i)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(e){e.removeClass(this.options.collapsedClass),e.children('[data-action="expand"]').hide(),e.children('[data-action="collapse"]').show(),e.children(this.options.listNodeName).show()},collapseItem:function(e){var t=e.children(this.options.listNodeName);t.length&&(e.addClass(this.options.collapsedClass),e.children('[data-action="collapse"]').hide(),e.children('[data-action="expand"]').show(),e.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(e(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(e(this))
})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(e(this.options.expandBtnHTML)),t.prepend(e(this.options.collapseBtnHTML))),t.children('[data-action="expand"]').hide()},unsetParent:function(e){e.removeClass(this.options.collapsedClass),e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var r=this.mouse,l=e(t.target),s=l.closest(this.options.itemNodeName);this.placeEl.css("height",s.height()),this.placeEl.css("width",s.width()),this.placeEl.css("display",s.css("display")),r.offsetX=t.offsetX!==o?t.offsetX:t.pageX-l.offset().left,r.offsetY=t.offsetY!==o?t.offsetY:t.pageY-l.offset().top,r.startX=r.lastX=t.pageX,r.startY=r.lastY=t.pageY,this.dragRootEl=this.el,this.el_offset=this.el.offset(),this.dragEl=e(i.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",s.width()),s.after(this.placeEl),s[0].parentNode.removeChild(s[0]),s.appendTo(this.dragEl),e(this.el).append(this.dragEl),this.dragEl.css({left:t.pageX-r.offsetX-this.el_offset.left,top:t.pageY-r.offsetY-this.el_offset.top});var a,n,d=this.dragEl.find(this.options.itemNodeName);for(a=0;a<d.length;a++)n=e(d[a]).parents(this.options.listNodeName).length,n>this.dragDepth&&(this.dragDepth=n)},dragStop:function(){var e=this.dragEl.children(this.options.itemNodeName).first();e[0].parentNode.removeChild(e[0]),this.placeEl.replaceWith(e),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(o){var r,l,a,n,d,p=this.options,h=this.mouse;this.dragEl.css({left:o.pageX-h.offsetX-this.el_offset.left,top:o.pageY-h.offsetY-this.el_offset.top}),h.lastX=h.nowX,h.lastY=h.nowY,h.nowX=o.pageX,h.nowY=o.pageY,h.distX=h.nowX-h.lastX,h.distY=h.nowY-h.lastY,h.lastDirX=h.dirX,h.lastDirY=h.dirY,h.dirX=0===h.distX?0:h.distX>0?1:-1,h.dirY=0===h.distY?0:h.distY>0?1:-1;var u=Math.abs(h.distX)>Math.abs(h.distY)?1:0;if(!h.moving)return h.dirAx=u,void(h.moving=!0);h.dirAx!==u?(h.distAxX=0,h.distAxY=0):(h.distAxX+=Math.abs(h.distX),0!==h.dirX&&h.dirX!==h.lastDirX&&(h.distAxX=0),h.distAxY+=Math.abs(h.distY),0!==h.dirY&&h.dirY!==h.lastDirY&&(h.distAxY=0)),h.dirAx=u,h.dirAx&&h.distAxX>=p.threshold&&(h.distAxX=0,a=this.placeEl.prev(p.itemNodeName),h.distX>0&&a.length&&!a.hasClass(p.collapsedClass)&&(r=a.find(p.listNodeName).last(),d=this.placeEl.parents(p.listNodeName).length,d+this.dragDepth<=p.maxDepth&&(r.length?(r=a.children(p.listNodeName).last(),r.append(this.placeEl)):(r=e("<"+p.listNodeName+"/>").addClass(p.listClass),r.append(this.placeEl),a.append(r),this.setParent(a)))),h.distX<0&&(n=this.placeEl.next(p.itemNodeName),n.length||(l=this.placeEl.parent(),this.placeEl.closest(p.itemNodeName).after(this.placeEl),l.children().length||this.unsetParent(l.parent()))));var c=!1;if(s||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(i.elementFromPoint(o.pageX-i.body.scrollLeft,o.pageY-(t.pageYOffset||i.documentElement.scrollTop))),s||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(p.handleClass)&&(this.pointEl=this.pointEl.closest("."+p.itemClass)),this.pointEl.hasClass(p.emptyClass))c=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(p.itemClass))return;var f=this.pointEl.closest("."+p.rootClass),v=this.dragRootEl.data("nestable-id")!==f.data("nestable-id");if(!h.dirAx||v||c){if(v&&p.group!==f.data("nestable-group"))return;if(d=this.dragDepth-1+this.pointEl.parents(p.listNodeName).length,d>p.maxDepth)return;var _=o.pageY<this.pointEl.offset().top+this.pointEl.height()/2;l=this.placeEl.parent(),c?(r=e(i.createElement(p.listNodeName)).addClass(p.listClass),r.append(this.placeEl),this.pointEl.replaceWith(r)):_?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),l.children().length||this.unsetParent(l.parent()),this.dragRootEl.find(p.itemNodeName).length||this.dragRootEl.append('<div class="'+p.emptyClass+'"/>'),v&&(this.dragRootEl=f,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},e.fn.nestable=function(t){var i=this,o=this;return i.each(function(){var i=e(this).data("nestable");i?"string"==typeof t&&"function"==typeof i[t]&&(o=i[t]()):(e(this).data("nestable",new r(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),o||i}}(window.jQuery||window.Zepto,window,document),fieldval_ui_extend(FVKeyValueField,FVField),FVKeyValueField.prototype.create_add_field_button=function(){var e=this,t=$("<button />").addClass("fv_add_field_button").text("+").on(FVForm.button_event,function(t){t.preventDefault(),e.new_field(e.fields.length)});return e.add_field_buttons.push(t),t},FVKeyValueField.prototype.new_field=function(){throw new Error("FVKeyValueField.new_field must be overriden to create fields")},FVKeyValueField.prototype.add_field=function(e,t){var i=this;t.in_key_value(i,function(){i.remove_field(t)}),t.element.appendTo(i.fields_element),i.fields.push(t),i.input_holder.nestable("init"),t.name_val(""),i.is_disabled&&t.disable()},FVKeyValueField.prototype.change_key_name=function(e,t,i){var o=this;if(void 0!==e){var r=o.keys[e];if(r!==i)throw new Error("Old key name does not match this field ",e);delete o.keys[e]}null===t&&(t="");for(var l=t,s=2;void 0!==o.keys[l];)l=t+"_"+s++;return o.keys[l]=i,l},FVKeyValueField.prototype.remove_field=function(e){for(var t=this,i=0;i<t.fields.length;i++)t.fields[i]===e&&t.fields.splice(i,1)},FVKeyValueField.prototype.error=function(e){FVKeyValueField.superClass.error.call(this,e)},FVKeyValueField.prototype.fields_error=function(e){var t=this;if(e){var i=e.invalid||{},o=e.missing||{},r=e.unrecognized||{};for(var l in t.keys){var s=t.keys[l],a=i[l]||o[l]||r[l]||null;s.error(a)}}else for(var l in t.keys){var s=t.keys[l];s.error(null)}},FVKeyValueField.prototype.clear_errors=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.clear_errors()}},FVKeyValueField.prototype.disable=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.disable()}for(var t=0;t<e.add_field_buttons.length;t++){var o=e.add_field_buttons[t];o.hide()}return FVField.prototype.disable.call(this)},FVKeyValueField.prototype.enable=function(){for(var e=this,t=0;t<e.fields.length;t++){var i=e.fields[t];i.enable()}for(var t=0;t<e.add_field_buttons.length;t++){var o=e.add_field_buttons[t];o.show()}return FVField.prototype.enable.call(this)},FVKeyValueField.prototype.error=function(e){var t=this;if(t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(0===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var i=$("<ul />"),o=0;o<e.errors.length;o++){var r=e.errors[o];0===r.error?t.fields_error(r):i.append($("<li />").text(r.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},FVKeyValueField.prototype.val=function(e){var t=this;if(0===arguments.length){var i={};for(var o in t.keys){var r=t.keys[o];if(r.output_flag!==!1){var l=r.val();i[o]=l}}return i}if(e)for(var o in e)if(e.hasOwnProperty(o)){var r=t.fields[o];r||(r=t.new_field(o)),r.val(e[o]),r.name_val(o)}return t},fieldval_ui_extend(FVForm,FVObjectField),FVForm.button_event="click",FVForm.is_mobile=/android|webos|iphone|ipad|ipod|blackberry|iemobile|nokia|series40|x11|opera mini/i.test(navigator.userAgent.toLowerCase()),$.tap&&(FVForm.button_event="tap"),FVForm.prototype.on_submit=function(e){var t=this;return t.submit_callbacks.push(e),t},FVForm.prototype.submit=function(){for(var e=this,t=e.val(),i=0;i<e.submit_callbacks.length;i++){var o=e.submit_callbacks[i];o(t)}return t};