function fieldval_ui_extend(e,t){function i(){}i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e,e.superConstructor=t,e.superClass=t.prototype}function FVForm(e){var t=this;t.element=$("<form />").addClass("fv_form").append(t.error_message=$("<div />").addClass("fv_error_message").hide()).on("submit",function(e){return e.preventDefault(),t.submit(),!1}),t.fields=e||{},t.fields_element=t.element,t.submit_callbacks=[]}function Field(e,t){var i=this;i.name=e,i.options=t||{},i.output_flag=!0,i.is_in_array=!1,i.on_change_callbacks=[],i.element=$("<div />").addClass("fv_field").data("field",i),i.title=$("<div />").addClass("fv_field_title").text(i.name),i.options.description&&(i.description_label=$("<div />").addClass("fv_field_description").text(i.options.description)),i.input_holder=$("<div />").addClass("fv_input_holder"),i.error_message=$("<div />").addClass("fv_error_message").hide(),i.layout()}function TextField(e,t){var i=this,r=typeof t;"string"===r?(i.input_type=t,t={}):"object"===r?i.input_type=t.type||"text":t={},TextField.superConstructor.call(this,e,t),i.element.addClass("fv_text_field"),i.input=$("textarea"===i.input_type?"<textarea />":"text"!==i.input_type&&"number"!==i.input_type&&i.input_type?"<input type='"+i.input_type+"' />":"<input type='text' />"),i.enter_callbacks=[],i.previous_value={},i.input.addClass("fv_text_input").attr("placeholder",e).on("keydown",function(e){if(13===e.keyCode)for(var t=0;t<i.enter_callbacks.length;t++)i.enter_callbacks[t](e)}).on("keyup paste cut",function(){setTimeout(function(){i.check_changed()},0)}).appendTo(i.input_holder)}function PasswordField(e){PasswordField.superConstructor.call(this,e,"password")}function DisplayField(e,t){var i=this;DisplayField.superConstructor.call(this,e,t),i.element.addClass("fv_display_field"),i.input=$("<div />").appendTo(i.input_holder),i.hide_on_form()}function ChoiceField(e,t){var i=this;ChoiceField.superConstructor.call(this,e,t),i.choices=i.options.choices||[],i.allow_empty=i.options.allow_empty||!1,i.element.addClass("fv_choice_field"),i.select=$("<select/>").addClass("fv_choice_input").appendTo(i.input_holder),setTimeout(function(){i.select.on("change",function(){i.did_change()})},100),i.choice_values=[],i.allow_empty&&(i.empty_option=$("<option />").prop({value:null}).text(i.options.empty_message||""),i.select.append(i.empty_option));for(var r=0;r<i.choices.length;r++){var o,a,n=i.choices[r];"object"==typeof n?(o=n[0],a=n[1]):o=a=n,i.choice_values.push(o);var l=$("<option />").prop("value",o).text(a);i.select.append(l)}}function DateField(e,t){var i=this;if("undefined"==typeof DateVal)return void console.error("DateField requires fieldval-dateval-js");DateField.superConstructor.call(this,e,t),i.element.addClass("fv_date_field"),i.format_string=i.options.format||"yyyy-MM-dd";var r=DateVal.date_format().check(i.format_string,function(e){i.format_array=e});if(r)return void console.error(r.error_message);i.inputs=[];for(var o=0;o<i.format_array.length;o++){var a=i.format_array[o],n=DateVal.date_components[a];i.add_element_from_component(a,n)}}function BooleanField(e,t){var i=this;BooleanField.superConstructor.call(this,e,t),i.element.addClass("fv_boolean_field"),i.input=$("<input type='checkbox' />").addClass("fv_boolean_input").on("change",function(){i.did_change()}).appendTo(i.input_holder)}function ObjectField(e,t){var i=this;ObjectField.superConstructor.call(this,e,t),i.element.addClass("fv_object_field"),i.fields_element=i.input_holder,i.fields={}}function ArrayField(e,t){var i=this;ArrayField.superConstructor.call(this,e,t),i.fields=[],i.add_field_buttons=[],i.element.addClass("fv_array_field"),i.input_holder.append(i.fields_element=$("<div />").addClass("fv_nested_fields"),i.create_add_field_button()),i.input_holder.nestable({rootClass:"fv_input_holder",itemClass:"fv_field",handleClass:"fv_field_move_handle",itemNodeName:"div.fv_field",listNodeName:"div.fv_nested_fields",collapseBtnHTML:"",expandBtnHTML:"",maxDepth:1}).on("change",function(){i.reorder()})}FVForm.button_event="click",FVForm.prototype.init=function(){var e=this;for(var t in e.fields){var i=e.fields[t];i.init()}},FVForm.prototype.remove=function(){var e=this;for(var t in e.fields){var i=e.fields[t];i.remove()}},FVForm.prototype.blur=function(){var e=this;for(var t in e.fields){var i=e.fields[t];i.blur()}return e},FVForm.prototype.edit_mode=function(){var e=this;for(var t in e.fields)e.fields[t].edit_mode();return e},FVForm.prototype.view_mode=function(){var e=this;for(var t in e.fields)e.fields[t].view_mode();return e},FVForm.prototype.on_submit=function(e){var t=this;return t.submit_callbacks.push(e),t},FVForm.prototype.submit=function(){for(var e=this,t=e.val(),i=0;i<e.submit_callbacks.length;i++){var r=e.submit_callbacks[i];r(t)}return t},FVForm.prototype.add_field=function(e,t){var i=this;return t.element.appendTo(i.fields_element),i.fields[e]=t,i},FVForm.prototype.remove_field=function(e){var t=this,i=t.fields[e];i&&(i.remove(),delete t.fields[e])},FVForm.prototype.clear_errors=function(){var e=this;e.error(null)},FVForm.prototype.fields_error=function(e){var t=this;if(e){var i=e.invalid||{},r=e.missing||{},o=e.unrecognized||{};for(var a in t.fields){var n=t.fields[a],l=i[a]||r[a]||o[a]||null;n.error(l)}}else for(var a in t.fields){var n=t.fields[a];n.error(null)}},FVForm.prototype.show_error=function(){var e=this;e.error_message.show()},FVForm.prototype.hide_error=function(){var e=this;e.error_message.hide()},FVForm.prototype.error=function(e){var t=this;if(t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(0===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var i=$("<ul />"),r=0;r<e.errors.length;r++){var o=e.errors[r];0===o.error?t.fields_error(o):i.append($("<li />").text(o.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},FVForm.prototype.disable=function(){var e=this;for(var t in e.fields){var i=e.fields[t];i.disable()}},FVForm.prototype.enable=function(){var e=this;for(var t in e.fields){var i=e.fields[t];i.enable()}},FVForm.prototype.val=function(e){var t=this;if(0===arguments.length){var i={};for(var r in t.fields){var o=t.fields[r];if(o.output_flag!==!1){var a=o.val();null!=a&&(i[r]=a)}}return i}if(e)for(var r in t.fields){var o=t.fields[r];o.val(e[r])}return t},Field.prototype.in_array=function(e){var t=this;t.is_in_array=!0,t.element.addClass("fv_nested").append(t.move_handle=$("<div />").addClass("fv_field_move_handle").html("&#8645;"),t.remove_button=$("<button />").addClass("fv_field_remove_button").html("&#10060;").on(FVForm.button_event,function(i){i.preventDefault(),e(),t.remove()}))},Field.prototype.init=function(){},Field.prototype.remove=function(){var e=this;e.element.remove()},Field.prototype.view_mode=function(){var e=this;e.is_in_array&&(e.remove_button.hide(),e.move_handle.hide()),e.element.addClass("fv_view_mode"),e.element.removeClass("fv_edit_mode"),console.log("view_mode ",e)},Field.prototype.edit_mode=function(){var e=this;e.is_in_array&&(e.remove_button.show(),e.move_handle.show()),e.element.addClass("fv_edit_mode"),e.element.removeClass("fv_view_mode"),console.log("edit_mode ",e)},Field.prototype.change_name=function(e){var t=this;return t.name=e,t},Field.prototype.layout=function(){var e=this;e.element.append(e.title,e.description_label,e.input_holder,e.error_message)},Field.prototype.on_change=function(e){var t=this;return t.on_change_callbacks.push(e),t},Field.prototype.output=function(e){var t=this;return t.output_flag=e,t},Field.prototype.did_change=function(){for(var e=this,t=e.val(),i=0;i<e.on_change_callbacks.length;i++){var r=e.on_change_callbacks[i];r(t)}return e},Field.prototype.icon=function(){},Field.prototype.val=function(){console.error("Did not override Field.val()")},Field.prototype.disable=function(){},Field.prototype.enable=function(){},Field.prototype.blur=function(){},Field.prototype.focus=function(){},Field.prototype.show_error=function(){var e=this;e.error_message.show()},Field.prototype.hide_error=function(){var e=this;e.error_message.hide()},Field.prototype.error=function(e){var t=this;if(e){if(t.error_message.empty(),4===e.error){for(var i=$("<ul />"),r=0;r<e.errors.length;r++){var o=e.errors[r];i.append($("<li />").text(o.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.element&&t.element.addClass("fv_field_error"),t.show_error()}else t.hide_error(),t.element&&t.element.removeClass("fv_field_error")},fieldval_ui_extend(TextField,Field),TextField.prototype.check_changed=function(){var e=this,t=e.val();t!==e.previous_value&&(e.previous_value=t,e.did_change())},TextField.prototype.on_enter=function(e){var t=this;return t.enter_callbacks.push(e),t},TextField.prototype.view_mode=function(){var e=this;e.input.prop({readonly:"readonly",disabled:"disabled"}),Field.prototype.view_mode.call(this)},TextField.prototype.edit_mode=function(){var e=this;e.input.prop({readonly:null,disabled:null}),Field.prototype.edit_mode.call(this)},TextField.prototype.icon=function(e){var t=this,i={"background-image":"url("+e.background+")","background-position":e.position,"background-repeat":"no-repeat","padding-left":e.width+"px"};return t.input.css(i),t},TextField.prototype.change_name=function(e){var t=this;return TextField.superClass.change_name.call(this,e),t.input.attr("placeholder",e),t},TextField.prototype.disable=function(){var e=this;return e.input.attr("disabled","disabled"),e},TextField.prototype.enable=function(){var e=this;return e.input.attr("disabled",null),e},TextField.prototype.focus=function(){var e=this;return e.input.focus(),e},TextField.prototype.blur=function(){var e=this;return e.input.blur(),e},TextField.numeric_regex=/^\d+(\.\d+)?$/,TextField.prototype.val=function(e){var t=this;if(0===arguments.length){var i=t.input.val();return"number"===t.input_type&&TextField.numeric_regex.test(i)?parseFloat(i):0===i.length?null:i}return t.input.val(e),t},fieldval_ui_extend(PasswordField,TextField),fieldval_ui_extend(DisplayField,Field),DisplayField.prototype.icon=function(e){var t=this,i={"background-image":"url("+e.background+")","background-position":e.position,"background-repeat":"no-repeat","padding-left":e.width+"px"};return t.input.css(i),t},DisplayField.prototype.change_name=function(e){var t=this;return DisplayField.superClass.change_name.call(this,e),t},DisplayField.replace_line_breaks=function(e){if("string"!=typeof e)return e;for(var t=[],i=e.split(/\n/),r=jQuery(document.createElement("div")),o=0;o<i.length;o++)t.push(r.text(i[o]).html());return t.join("<br>")},DisplayField.prototype.val=function(e){var t=this;return 0===arguments.length?t.input.text():(t.input.html(DisplayField.replace_line_breaks(e)),t)},fieldval_ui_extend(ChoiceField,Field),ChoiceField.prototype.disable=function(){var e=this;return e.select.prop("disabled","disabled"),e},ChoiceField.prototype.enable=function(){var e=this;return e.select.prop("disabled",null),e},ChoiceField.prototype.view_mode=function(){var e=this;e.disable(),Field.prototype.view_mode.call(this)},ChoiceField.prototype.edit_mode=function(){var e=this;e.enable(),Field.prototype.edit_mode.call(this)},ChoiceField.prototype.focus=function(){var e=this;return e.select.focus(),e},ChoiceField.prototype.blur=function(){var e=this;return e.select.blur(),e},ChoiceField.prototype.val=function(e){var t=this;if(0===arguments.length){var i=t.select.find(":selected"),r=i.index()-(t.allow_empty?1:0);return t.allow_empty&&-1===r?null:t.choice_values[r]}return t.select.val(void 0!==e?e:t.allow_empty?t.empty_option:t.choice_values[0]),t},fieldval_ui_extend(DateField,Field),DateField.prototype.add_element_from_component=function(e,t){var i=this;if(0===t){var r=e;i.inputs.push(null),i.input_holder.append($("<div />").addClass("fv_date_separator").text(r))}else{var o=t[t.length-1],a=$("<input />").attr({placeholder:e,size:o,maxlength:o}).addClass("fv_date_input").on("keyup",function(){i.did_change()});a.blur(function(){var e=a.val(),i=DateVal.pad_to_valid(e,t);a.val(i)}),i.inputs.push(a),i.input_holder.append(a)}},DateField.prototype.icon=function(){var e=this;return e},DateField.prototype.change_name=function(e){var t=this;return DateField.superClass.change_name.call(this,e),t.input.attr("placeholder",e),t},DateField.prototype.disable=function(){for(var e=this,t=0;t<e.inputs.length;t++){var i=e.inputs[t];i&&i.attr("disabled","disabled")}return e},DateField.prototype.enable=function(){for(var e=this,t=0;t<e.inputs.length;t++){var i=e.inputs[t];i&&i.attr("disabled",null)}return e},DateField.prototype.focus=function(){var e=this,t=e.inputs[0];return t&&t.blur(),e},DateField.prototype.blur=function(){for(var e=this,t=0;t<e.inputs.length;t++){var i=e.inputs[t];i&&i.blur()}return e},DateField.prototype.val=function(e){var t=this;if(0===arguments.length){for(var i="",r=0;r<t.format_array.length;r++){var o=t.format_array[r],a=DateVal.date_components[o];if(0===a)i+=o;else{var n=t.inputs[r],l=n.val().toString();i+=DateVal.pad_to_valid(l,a)}}return i}if(null!=e){"number"==typeof e?e=DateVal.date_with_format_array(new Date(e),t.format_array):e instanceof Date&&(e=DateVal.date_with_format_array(e,t.format_array));var s=DateVal.date(t.format_string,{emit:DateVal.EMIT_COMPONENT_ARRAY}).check(e,function(e){as_components=e});if(s)return void console.error("Invalid format passed to .val of DateField");for(var r=0;r<t.format_array.length;r++){var o=t.format_array[r],a=DateVal.date_components[o];if(0===a)i+=o;else{var n=t.inputs[r];n.val(as_components[r])}}}return t},fieldval_ui_extend(BooleanField,Field),BooleanField.prototype.disable=function(){var e=this;return e.input.attr("disabled","disabled"),e},BooleanField.prototype.enable=function(){var e=this;return e.input.attr("disabled",null),e},BooleanField.prototype.focus=function(){var e=this;return e.input.focus(),e},BooleanField.prototype.blur=function(){var e=this;return e.input.blur(),e},BooleanField.prototype.val=function(e){var t=this;return 0===arguments.length?t.input.is(":checked"):("true"===e?e=!0:"false"===e&&(e=!1),t.input.prop("checked",e),t)},fieldval_ui_extend(ObjectField,Field),ObjectField.prototype.init=function(){FVForm.prototype.init.call(this)},ObjectField.prototype.remove=function(){FVForm.prototype.remove.call(this),Field.prototype.remove.call(this)},ObjectField.prototype.add_field=function(e,t){FVForm.prototype.add_field.call(this,e,t)},ObjectField.prototype.change_name=function(e){var t=this;return ObjectField.superClass.change_name.call(this,e),t},ObjectField.prototype.view_mode=function(){var e=this;for(var t in e.fields)e.fields[t].view_mode();Field.prototype.view_mode.call(this)},ObjectField.prototype.edit_mode=function(){var e=this;for(var t in e.fields)e.fields[t].edit_mode();Field.prototype.edit_mode.call(this)},ObjectField.prototype.disable=function(){var e=this;return e},ObjectField.prototype.enable=function(){var e=this;return e},ObjectField.prototype.focus=function(){var e=this;return e},ObjectField.prototype.blur=function(){FVForm.prototype.blur.call(this)},ObjectField.prototype.error=function(e){ObjectField.superClass.error.call(this,e),FVForm.prototype.error.call(this,e)},ObjectField.prototype.fields_error=function(e){FVForm.prototype.fields_error.call(this,e)},ObjectField.prototype.clear_errors=function(){FVForm.prototype.clear_errors.call(this)},ObjectField.prototype.val=function(e){var t=this;if(0===arguments.length){var i={};for(var r in t.fields){var o=t.fields[r];i[r]=o.val()}return i}for(var r in e){var o=t.fields[r];o&&o.val(e[r])}return t},function(e,t,i,r){function o(t,r){this.w=e(i),this.el=e(t),this.options=e.extend({},l,r),this.init()}var a="ontouchstart"in i,n=function(){var e=i.createElement("div"),r=i.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",r.appendChild(e);var o=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return r.removeChild(e),!!o}(),l={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};o.prototype={init:function(){var i=this;i.reset(),i.el.data("nestable-group",this.options.group),i.placeEl=e('<div class="'+i.options.placeClass+'"/>'),e.each(this.el.find(i.options.itemNodeName),function(t,r){i.setParent(e(r))}),i.el.on("click","button",function(t){if(!i.dragEl){var r=e(t.currentTarget),o=r.data("action"),a=r.parent(i.options.itemNodeName);"collapse"===o&&i.collapseItem(a),"expand"===o&&i.expandItem(a)}});var r=function(t){var r=e(t.target);if(!r.hasClass(i.options.handleClass)){if(r.closest("."+i.options.noDragClass).length)return;r=r.closest("."+i.options.handleClass)}r.length&&!i.dragEl&&(i.isTouch=/^touch/.test(t.type),i.isTouch&&1!==t.touches.length||(t.preventDefault(),i.dragStart(t.touches?t.touches[0]:t)))},o=function(e){i.dragEl&&(e.preventDefault(),i.dragMove(e.touches?e.touches[0]:e))},n=function(e){i.dragEl&&(e.preventDefault(),i.dragStop(e.touches?e.touches[0]:e))};a&&(i.el[0].addEventListener("touchstart",r,!1),t.addEventListener("touchmove",o,!1),t.addEventListener("touchend",n,!1),t.addEventListener("touchcancel",n,!1)),i.el.on("mousedown",r),i.w.on("mousemove",o),i.w.on("mouseup",n)},serialize:function(){var t,i=0,r=this;return step=function(t,i){var o=[],a=t.children(r.options.itemNodeName);return a.each(function(){var t=e(this),a=e.extend({},t.data()),n=t.children(r.options.listNodeName);n.length&&(a.children=step(n,i+1)),o.push(a)}),o},t=step(r.el.find(r.options.listNodeName).first(),i)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(e){e.removeClass(this.options.collapsedClass),e.children('[data-action="expand"]').hide(),e.children('[data-action="collapse"]').show(),e.children(this.options.listNodeName).show()},collapseItem:function(e){var t=e.children(this.options.listNodeName);t.length&&(e.addClass(this.options.collapsedClass),e.children('[data-action="collapse"]').hide(),e.children('[data-action="expand"]').show(),e.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(e(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(e(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(e(this.options.expandBtnHTML)),t.prepend(e(this.options.collapseBtnHTML))),t.children('[data-action="expand"]').hide()},unsetParent:function(e){e.removeClass(this.options.collapsedClass),e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var o=this.mouse,a=e(t.target),n=a.closest(this.options.itemNodeName);this.placeEl.css("height",n.height()),this.placeEl.css("width",n.width()),this.placeEl.css("display",n.css("display")),o.offsetX=t.offsetX!==r?t.offsetX:t.pageX-a.offset().left,o.offsetY=t.offsetY!==r?t.offsetY:t.pageY-a.offset().top,o.startX=o.lastX=t.pageX,o.startY=o.lastY=t.pageY,this.dragRootEl=this.el,this.el_offset=this.el.offset(),this.dragEl=e(i.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",n.width()),n.after(this.placeEl),n[0].parentNode.removeChild(n[0]),n.appendTo(this.dragEl),e(this.el).append(this.dragEl),this.dragEl.css({left:t.pageX-o.offsetX-this.el_offset.left,top:t.pageY-o.offsetY-this.el_offset.top});var l,s,d=this.dragEl.find(this.options.itemNodeName);for(l=0;l<d.length;l++)s=e(d[l]).parents(this.options.listNodeName).length,s>this.dragDepth&&(this.dragDepth=s)},dragStop:function(){var e=this.dragEl.children(this.options.itemNodeName).first();e[0].parentNode.removeChild(e[0]),this.placeEl.replaceWith(e),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(r){var o,a,l,s,d,p=this.options,u=this.mouse;this.dragEl.css({left:r.pageX-u.offsetX-this.el_offset.left,top:r.pageY-u.offsetY-this.el_offset.top}),u.lastX=u.nowX,u.lastY=u.nowY,u.nowX=r.pageX,u.nowY=r.pageY,u.distX=u.nowX-u.lastX,u.distY=u.nowY-u.lastY,u.lastDirX=u.dirX,u.lastDirY=u.dirY,u.dirX=0===u.distX?0:u.distX>0?1:-1,u.dirY=0===u.distY?0:u.distY>0?1:-1;var f=Math.abs(u.distX)>Math.abs(u.distY)?1:0;if(!u.moving)return u.dirAx=f,void(u.moving=!0);u.dirAx!==f?(u.distAxX=0,u.distAxY=0):(u.distAxX+=Math.abs(u.distX),0!==u.dirX&&u.dirX!==u.lastDirX&&(u.distAxX=0),u.distAxY+=Math.abs(u.distY),0!==u.dirY&&u.dirY!==u.lastDirY&&(u.distAxY=0)),u.dirAx=f,u.dirAx&&u.distAxX>=p.threshold&&(u.distAxX=0,l=this.placeEl.prev(p.itemNodeName),u.distX>0&&l.length&&!l.hasClass(p.collapsedClass)&&(o=l.find(p.listNodeName).last(),d=this.placeEl.parents(p.listNodeName).length,d+this.dragDepth<=p.maxDepth&&(o.length?(o=l.children(p.listNodeName).last(),o.append(this.placeEl)):(o=e("<"+p.listNodeName+"/>").addClass(p.listClass),o.append(this.placeEl),l.append(o),this.setParent(l)))),u.distX<0&&(s=this.placeEl.next(p.itemNodeName),s.length||(a=this.placeEl.parent(),this.placeEl.closest(p.itemNodeName).after(this.placeEl),a.children().length||this.unsetParent(a.parent()))));var c=!1;if(n||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(i.elementFromPoint(r.pageX-i.body.scrollLeft,r.pageY-(t.pageYOffset||i.documentElement.scrollTop))),n||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(p.handleClass)&&(this.pointEl=this.pointEl.closest("."+p.itemClass)),this.pointEl.hasClass(p.emptyClass))c=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(p.itemClass))return;var h=this.pointEl.closest("."+p.rootClass),v=this.dragRootEl.data("nestable-id")!==h.data("nestable-id");if(!u.dirAx||v||c){if(v&&p.group!==h.data("nestable-group"))return;if(d=this.dragDepth-1+this.pointEl.parents(p.listNodeName).length,d>p.maxDepth)return;var _=r.pageY<this.pointEl.offset().top+this.pointEl.height()/2;a=this.placeEl.parent(),c?(o=e(i.createElement(p.listNodeName)).addClass(p.listClass),o.append(this.placeEl),this.pointEl.replaceWith(o)):_?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),a.children().length||this.unsetParent(a.parent()),this.dragRootEl.find(p.itemNodeName).length||this.dragRootEl.append('<div class="'+p.emptyClass+'"/>'),v&&(this.dragRootEl=h,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},e.fn.nestable=function(t){var i=this,r=this;return i.each(function(){var i=e(this).data("nestable");i?"string"==typeof t&&"function"==typeof i[t]&&(r=i[t]()):(e(this).data("nestable",new o(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),r||i}}(window.jQuery||window.Zepto,window,document),fieldval_ui_extend(ArrayField,Field),ArrayField.prototype.reorder=function(){var e=this;e.fields=[];for(var t=e.fields_element.children(),i=0;i<t.length;i++){var r=$(t[i]),o=r.data("field");e.fields.push(o)}},ArrayField.prototype.create_add_field_button=function(){var e=this,t=$("<button />").addClass("fv_add_field_button").text("+").on(FVForm.button_event,function(t){t.preventDefault(),e.new_field(e.fields.length)});return e.add_field_buttons.push(t),t},ArrayField.prototype.new_field=function(){throw new Error("ArrayField.new_field must be overriden to create fields")},ArrayField.prototype.add_field=function(e,t){var i=this;t.in_array(function(){i.remove_field(t)}),t.element.appendTo(i.fields_element),i.fields.push(t),i.input_holder.nestable("init")},ArrayField.prototype.remove_field=function(e){for(var t=this,i=0;i<t.fields.length;i++)t.fields[i]===e&&t.fields.splice(i,1)},ArrayField.prototype.view_mode=function(){var e=this;for(var t in e.fields)e.fields[t].view_mode();for(var t=0;t<e.add_field_buttons.length;t++){var i=e.add_field_buttons[t];i.hide()}},ArrayField.prototype.edit_mode=function(){var e=this;for(var t in e.fields)e.fields[t].edit_mode();for(var t=0;t<e.add_field_buttons.length;t++){var i=e.add_field_buttons[t];i.show()}},ArrayField.prototype.error=function(e){ArrayField.superClass.error.call(this,e)},ArrayField.prototype.fields_error=function(e){var t=this;if(e)for(var i=e.invalid||{},r=e.missing||{},o=e.unrecognized||{},a=0;a<t.fields.length;a++){var n=t.fields[a],l=i[a]||r[a]||o[a]||null;n.error(l)}else for(var a in t.fields){var n=t.fields[a];n.error(null)}},ArrayField.prototype.clear_errors=function(){},ArrayField.prototype.error=function(e){var t=this;if(t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(0===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var i=$("<ul />"),r=0;r<e.errors.length;r++){var o=e.errors[r];0===o.error?t.fields_error(o):i.append($("<li />").text(o.error_message))}t.error_message.append(i)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},ArrayField.prototype.val=function(e){var t=this;if(0===arguments.length){for(var i=[],r=0;r<t.fields.length;r++){var o=t.fields[r],a=o.val();i.push(a)}return i}if(e)for(var r=0;r<e.length;r++){var o=t.fields[r];o||(o=t.new_field(r)),o.val(e[r])}return t};