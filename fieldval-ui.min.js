function fieldval_ui_extend(e,t){function r(){}r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e,e.superConstructor=t,e.superClass=t.prototype}function FVField(e,t){var r=this;if(r.name=e,r.options=t||{},r.output_flag=!0,r.is_in_array=!1,r.key_value_parent=null,r.is_in_key_value=!1,r.is_disabled=!1,r.on_change_callbacks=[],r.on_focus_callbacks=[],r.on_blur_callbacks=[],r.options.use_form){r.element=$("<form />",{novalidate:"novalidate"}).addClass("fv_field fv_form").data("field",r);var i=function(e){return e.preventDefault(),r.submit(),!1},o=r.element[0];o.addEventListener?o.addEventListener("submit",i):o.attachEvent&&o.attachEvent("submit",i),r.on_submit_callbacks=[]}else r.element=$("<div />").addClass("fv_field").data("field",r);r.title=$("<div />").addClass("fv_field_title").text(r.name?r.name:""),r.name||r.title.hide(),r.options.description&&(r.description_label=$("<div />").addClass("fv_field_description").text(r.options.description)),r.input_holder=$("<div />").addClass("fv_input_holder"),r.error_message=$("<div />").addClass("fv_error_message").hide(),r.layout()}function FVTextField(e,t){var r=this,i=typeof t;"string"===i?(r.input_type=t,t={}):"object"===i?(r.input_type=t.type||"text",r.consume_tabs=t.consume_tabs||!1):t={},FVTextField.superConstructor.call(this,e,t),r.element.addClass("fv_text_field"),r.input=$("textarea"===r.input_type?"<textarea />":"text"!==r.input_type&&"number"!==r.input_type&&r.input_type?"<input type='"+r.input_type+"' />":"<input type='text' />"),r.enter_callbacks=[],r.previous_value={},r.input.addClass("fv_text_input").attr("placeholder",e).on("keydown",function(e){if(13===e.keyCode){for(var t=0;t<r.enter_callbacks.length;t++)r.enter_callbacks[t](e);if("textarea"===r.input_type&&(event.metaKey||event.ctrlKey)){var i=r.element.closest("form");i&&i.data("field").submit()}}"textarea"===r.input_type&&r.consume_tabs&&9===e.keyCode&&(e.preventDefault(),document.execCommand("insertText",!1,"	"))}).on("keyup paste cut",function(){setTimeout(function(){r.check_changed()},0)}).on("focus",function(){r.did_focus()}).on("blur",function(){r.did_blur()}).appendTo(r.input_holder)}function FVPasswordField(e){FVPasswordField.superConstructor.call(this,e,{type:"password"})}function FVDisplayField(e,t){var r=this;FVDisplayField.superConstructor.call(this,e,t),r.element.addClass("fv_display_field"),r.input=$("<div />").appendTo(r.input_holder),r.output_flag=!1}function FVChoiceOption(e,t){var r=this;r.parent=t,null===e?(r.choice_text=t.empty_text,r.choice_value=null):"object"==typeof e?(r.choice_value=e[0],r.choice_text=e[1].toString()):(r.choice_value=e,r.choice_text=e.toString()),r.element=$("<div />").addClass("fv_choice_option").text(r.choice_text),r.add_mouse_events()}function FVChoiceField(e,t){var r=this;if(FVChoiceField.superConstructor.call(this,e,t),r.element.addClass("fv_choice_field"),r.choices=r.options.choices||[],r.allow_empty=r.options.allow_empty||!1,r.empty_text=r.options.empty_text||"",r.clear_filter_on_select=void 0!=r.options.clear_filter_on_select?r.options.clear_filter_on_select:!0,r.clear_filter_on_focus=void 0!=r.options.clear_filter_on_focus?r.options.clear_filter_on_focus:!0,r.option_array=[],r.selected_value=null,r.option_class=t.option_class||FVChoiceOption,r.select=$("<div/>").addClass("fv_choice_input").append(r.filter_input=$("<input type='text' />").on("focus",function(){setTimeout(function(){r.input_focus()},1)}).attr("placeholder",e).addClass("filter_input").on("blur",function(){r.is_mousedown||r.blur()}),r.current_display=$("<div />").addClass("fv_choice_display fv_choice_placeholder").on(FVForm.button_event,function(){r.focus()}).text(r.name),r.choice_list=$("<div />").addClass("fv_choice_list").bind("mousewheel DOMMouseScroll",function(e){var t=null;"mousewheel"==e.type?t=e.originalEvent.wheelDelta*-.5:"DOMMouseScroll"==e.type&&(t=40*e.originalEvent.detail),t&&(e.preventDefault(),$(this).scrollTop(t+$(this).scrollTop()))})).appendTo(r.input_holder),r.filter_input.addClass("fv_filter_hidden").on("keydown",function(e){r.filter_key_down(e)}).on("keyup",function(e){r.filter_key_up(e)}),$("html").on(FVForm.button_event,function(e){r.filter_input.is(":visible")&&($(e.target).closest(r.filter_input).length||r.hide_list())}),r.allow_empty){var i=new r.option_class(null,r);r.add_option(i)}for(var o=0;o<r.choices.length;o++){var n=r.choices[o],i=new r.option_class(n,r);r.add_option(i)}r.filter("")}function FVDateField(e,t){var r=this;if("undefined"==typeof DateVal)return void console.error("FVDateField requires the FieldVal package");FVDateField.superConstructor.call(this,e,t),r.element.addClass("fv_date_field"),r.format_string=r.options.format||"yyyy-MM-dd";var i=DateVal.date_format().check(r.format_string,function(e){r.format_array=e});if(i)return void console.error(i.error_message);r.inputs=[];for(var o=0;o<r.format_array.length;o++){var n=r.format_array[o],l=DateVal.date_components[n];r.add_element_from_component(n,l)}}function FVBooleanField(e,t){var r=this;FVBooleanField.superConstructor.call(this,e,t),r.element.addClass("fv_boolean_field"),r.input=$("<input type='checkbox' />").addClass("fv_boolean_input").on("change",function(){r.did_change()}).on("focus",function(){r.did_focus()}).on("blur",function(){r.did_blur()}).appendTo(r.input_holder)}function FVObjectField(e,t){var r=this;FVObjectField.superConstructor.call(this,e,t),r.element.addClass("fv_object_field"),r.fields_element=r.input_holder,r.fields={}}function FVArrayField(e,t){var r=this;FVArrayField.superConstructor.call(this,e,t),r.hide_add_button=r.options.hide_add_button||!1,r.hide_remove_button=r.options.hide_remove_button||!1,r.sortable=r.options.sortable||!1,r.fields=[],r.add_button_text=void 0!==r.options.add_button_text?r.options.add_button_text:"+",r.add_field_buttons=[],r.element.addClass("fv_array_field"),r.input_holder.append(r.fields_element=$("<div />").addClass("fv_array_fields")),r.hide_add_button||r.input_holder.append(r.create_add_field_button()),r.sortable&&(r.element.addClass("fv_array_field_sortable"),r.fields_element.nestable({rootClass:"fv_array_fields",itemClass:"fv_field",handleClass:"fv_field_move_handle",itemNodeName:"div.fv_field",listNodeName:"div",threshold:40}).on("change",function(){r.reorder()}))}function FVKeyValueField(e,t){var r=this;FVKeyValueField.superConstructor.call(this,e,t),r.fields=[],r.keys={},r.add_button_text=void 0!==r.options.add_button_text?r.options.add_button_text:"+",r.add_field_buttons=[],r.element.addClass("fv_key_value_field"),r.input_holder.append(r.fields_element=$("<div />").addClass("fv_key_value_fields"),r.create_add_field_button())}function FVProxyField(e,t){var r=this;FVProxyField.superConstructor.call(this,e,t),r.element.addClass("fv_proxy_field"),r.input_holder.append($("<div />").addClass("loading_label").text("Loading...")),r.init_called=!1,r.last_val=void 0,r.inner_field=null,r.on_replace_callbacks=[]}function FVForm(){var e=this;FVForm.superConstructor.call(this,null,{use_form:!0}),e.element.addClass("fv_form")}FVField.prototype.clear_errors=function(){var e=this;return e.error(null),e},FVField.prototype.on_submit=function(e){var t=this;return t.on_submit_callbacks.push(e),t},FVField.prototype.submit=function(){for(var e=this,t=e.val(),r=0;r<e.on_submit_callbacks.length;r++){var i=e.on_submit_callbacks[r];i(t)}return t},FVField.prototype.in_array=function(e,t){var r=this;return r.array_parent=e,r.is_in_array=!0,r.array_remove_callback=t,r.element.addClass("fv_in_array"),r.array_parent.sortable&&r.element.append(r.move_handle=$("<div />").addClass("fv_field_move_handle")),r.array_parent.hide_remove_button||r.element.addClass("with_remove_button").append(r.remove_button=$("<button />",{type:"button"}).addClass("fv_field_remove_button").html("&#10006;").on(FVForm.button_event,function(e){e.preventDefault(),r.array_remove_callback(r.key_name),t(),r.remove()})),r},FVField.prototype.in_key_value=function(e,t){var r=this;return r.key_value_parent=e,r.is_in_key_value=!0,r.key_value_remove_callback=t,r.name_input=new FVTextField("Key").on_change(function(e){r.key_name=r.key_value_parent.change_key_name(r.key_name,e,r),r.key_value_parent.did_change()}),r.name_input.element.addClass("fv_key_value_name_input"),r.title.replaceWith(r.name_input.element),r.element.addClass("fv_in_key_value").append(r.remove_button=$("<button />",{type:"button"}).addClass("fv_field_remove_button").html("&#10006;").on(FVForm.button_event,function(e){e.preventDefault(),r.key_value_remove_callback(r.key_name),r.remove()})),r},FVField.prototype.init=function(){var e=this;return e},FVField.prototype.remove=function(e,t){var r=this;return r.element.remove(),r.parent&&!e&&(r.parent.remove_field(r,t),r.parent=null),r},FVField.prototype.change_name=function(e){var t=this;return t.name=e,t},FVField.prototype.layout=function(){var e=this;return e.element.append(e.title,e.description_label,e.input_holder,e.error_message),e},FVField.prototype.on_change=function(e){var t=this;return t.on_change_callbacks.push(e),t},FVField.prototype.on_focus=function(e){var t=this;return t.on_focus_callbacks.push(e),t},FVField.prototype.on_blur=function(e){var t=this;return t.on_blur_callbacks.push(e),t},FVField.prototype.output=function(e){var t=this;return t.output_flag=e,t},FVField.prototype.did_change=function(e){var t=this;void 0===e&&(e={});for(var r=t.val(),i=0;i<t.on_change_callbacks.length;i++){var o=t.on_change_callbacks[i];o(r)}return t.parent&&!e.ignore_parent_change&&t.parent.did_change(),t},FVField.prototype.did_focus=function(){for(var e=this,t=0;t<e.on_focus_callbacks.length;t++){var r=e.on_focus_callbacks[t];r()}return e.parent&&e.parent.did_focus(),e},FVField.prototype.did_blur=function(){var e=this;if(e.suppress_blur)return e;for(var t=0;t<e.on_blur_callbacks.length;t++){var r=e.on_blur_callbacks[t];r()}return e.parent&&e.parent.did_blur(),e},FVField.prototype.icon=function(){var e=this;return e},FVField.prototype.val=function(){console.error("Did not override FVField.val()")},FVField.prototype.disable=function(){var e=this;return e.is_disabled=!0,e.element.addClass("fv_disabled"),e.name_input&&e.name_input.disable(),e.move_handle&&e.move_handle.hide(),e.remove_button&&e.remove_button.hide(),e},FVField.prototype.enable=function(){var e=this;return e.is_disabled=!1,e.element.removeClass("fv_disabled"),e.name_input&&e.name_input.enable(),e.move_handle&&e.move_handle.show(),e.remove_button&&e.remove_button.show(),e},FVField.prototype.blur=function(){var e=this;return e.name_input&&e.name_input.blur(),e},FVField.prototype.focus=function(){var e=this;return e},FVField.prototype.show_error=function(){var e=this;return e.error_message.show(),e},FVField.prototype.hide_error=function(){var e=this;return e.error_message.hide(),e},FVField.prototype.name_val=function(){var e=this,t=e.name_input.val.apply(e.name_input,arguments);return e.key_name=e.key_value_parent.change_key_name(e.key_name,e.name_input.val(),e),t},FVField.prototype.error=function(e){var t=this;if(e){if(t.error_message.empty(),4===e.error){for(var r=$("<ul />"),i=0;i<e.errors.length;i++){var o=e.errors[i];r.append($("<li />").text(o.error_message))}t.error_message.append(r)}else t.error_message.append($("<span />").text(e.error_message));t.element&&t.element.addClass("fv_field_error"),t.show_error()}else t.hide_error(),t.element&&t.element.removeClass("fv_field_error")},fieldval_ui_extend(FVTextField,FVField),FVTextField.prototype.check_changed=function(){var e=this,t=e.val();return t!==e.previous_value&&(e.previous_value=t,e.did_change()),e},FVTextField.prototype.on_enter=function(e){var t=this;return t.enter_callbacks.push(e),t},FVTextField.prototype.icon=function(e){var t=this,r={"background-image":"url("+e.background+")","background-position":e.position,"background-repeat":"no-repeat","padding-left":e.width+"px"};return t.input.css(r),t},FVTextField.prototype.change_name=function(e){var t=this;return FVTextField.superClass.change_name.call(this,e),t.input.attr("placeholder",e),t},FVTextField.prototype.disable=function(){var e=this;return e.input.attr("disabled","disabled"),FVField.prototype.disable.call(this)},FVTextField.prototype.enable=function(){var e=this;return e.input.attr("disabled",null),FVField.prototype.enable.call(this)},FVTextField.prototype.focus=function(){var e=this;return e.input.focus(),FVField.prototype.focus.call(this)},FVTextField.prototype.blur=function(){var e=this;return e.input.blur(),FVField.prototype.blur.call(this)},FVTextField.numeric_regex=/^[-+]?\d*\.?\d+$/,FVTextField.prototype.val=function(e,t){var r=this;if(t=t||{},0===arguments.length){var i=r.input.val();return"number"===r.input_type&&FVTextField.numeric_regex.test(i)?parseFloat(i):0===i.length?null:i}return r.input.val(e),t.ignore_change||r.did_change(t),r},fieldval_ui_extend(FVPasswordField,FVTextField),fieldval_ui_extend(FVDisplayField,FVField),FVDisplayField.prototype.icon=function(e){var t=this,r={"background-image":"url("+e.background+")","background-position":e.position,"background-repeat":"no-repeat","padding-left":e.width+"px"};return t.input.css(r),t},FVDisplayField.replace_line_breaks=function(e){if("string"!=typeof e)return e;for(var t=[],r=e.split(/\n/),i=jQuery(document.createElement("div")),o=0;o<r.length;o++)t.push(i.text(r[o]).html());return t.join("<br>")},FVDisplayField.prototype.val=function(e,t){var r=this;return t=t||{},0===arguments.length?r.input.text():(r.input.html(FVDisplayField.replace_line_breaks(e)),t.ignore_change||r.did_change(t),r)},FVChoiceOption.prototype.add_mouse_events=function(){var e=this,t=e.parent;return e.element.on("mousedown",function(e){e.isDefaultPrevented&&e.isDefaultPrevented()||e.originalEvent&&e.originalEvent.defaultPrevented||(t.mousedown(),e.preventDefault())}).on("mouseup",function(e){e.isDefaultPrevented&&e.isDefaultPrevented()||e.originalEvent&&e.originalEvent.defaultPrevented||(t.mouseup(),e.preventDefault())}).on(FVForm.button_event,function(r){r.isDefaultPrevented&&r.isDefaultPrevented()||r.originalEvent&&r.originalEvent.defaultPrevented||(t.default_click(r,e),r.preventDefault())}),e},FVChoiceOption.prototype.matches_filter=function(e){var t=this;if(null===t.choice_value){if(0===e.length)return!0}else if(0===t.choice_text.toLowerCase().indexOf(e.toLowerCase()))return!0},FVChoiceOption.prototype.matches_value=function(e){var t=this;return t.get_value()===e?!0:!1},FVChoiceOption.prototype.get_value=function(){var e=this;return e.choice_value},FVChoiceOption.prototype.add_highlight=function(){var e=this;return e.element.addClass("fv_highlighted"),e},FVChoiceOption.prototype.remove_highlight=function(){var e=this;return e.element.removeClass("fv_highlighted"),e},FVChoiceOption.prototype.add_selected=function(){var e=this;return e.element.addClass("fv_selected"),e},FVChoiceOption.prototype.remove_selected=function(){var e=this;return e.element.removeClass("fv_selected"),e},FVChoiceOption.prototype.hide=function(){var e=this;return e.element.hide(),e},FVChoiceOption.prototype.show=function(){var e=this;return e.element.show(),e},FVChoiceOption.prototype.get_display=function(){var e=this;return $("<div />").text(e.choice_text)},fieldval_ui_extend(FVChoiceField,FVField),FVChoiceField.prototype.mousedown=function(){var e=this;return e.is_mousedown=!0,e},FVChoiceField.prototype.mouseup=function(){var e=this;return e.is_mousedown=!1,e},FVChoiceField.prototype.filter_enter_up=function(){var e=this;return e.select_highlighted(),e},FVChoiceField.prototype.filter_esc_up=function(){var e=this;return e.hide_list(),e},FVChoiceField.prototype.filter_key_up=function(e){var t=this;return 9===e.keyCode?(e.preventDefault(),t):40===e.keyCode?(t.move_down(),e.preventDefault(),t):38===e.keyCode?(t.move_up(),e.preventDefault(),t):13===e.keyCode?(t.filter_enter_up(),e.preventDefault(),t):(27===e.keyCode&&(t.filter_esc_up(),e.preventDefault()),t.filter(t.filter_input.val()),t)},FVChoiceField.prototype.filter_key_down=function(e){var t=this;return(38===e.keyCode||40===e.keyCode||13===e.keyCode)&&e.preventDefault(),t},FVChoiceField.prototype.show_list=function(){var e=this;if(!e.is_disabled){if(e.list_open)return e;e.input_holder.css("min-height",e.current_display.outerHeight()+"px"),e.filter_input.removeClass("fv_filter_hidden"),e.current_display.hide(),e.choice_list.show(),e.current_highlight=e.selected_value,e.filter(e.filter_input.val(),!0),e.list_open=!0}return e},FVChoiceField.prototype.hide_list=function(){var e=this;return e.current_highlight&&(e.current_highlight.remove_highlight(),e.current_highlight=null),e.input_holder.css("min-height",""),e.filter_input.addClass("fv_filter_hidden"),e.current_display.show(),e.choice_list.hide(),e.list_open=!1,e},FVChoiceField.prototype.filter=function(e,t){var r=this;r.current_highlight&&r.current_highlight.remove_highlight();for(var i=null,o=0;o<r.option_array.length;o++){var n=r.option_array[o];n.matches_filter(e)?(n.show(),i||(i=n)):n.hide()}return t&&r.current_highlight||(r.current_highlight=i),r.current_highlight&&r.current_highlight.add_highlight(),r},FVChoiceField.prototype.value_to_text=function(e){for(var t=this,r=0;r<t.option_array.length;r++){var i=t.option_array[r];if(i===e)return t.choice_texts[r]}return null},FVChoiceField.prototype.select_option=function(e,t){var r=this;if(t=t||{},r.selected_value&&r.selected_value.remove_selected(),r.selected_value=e,r.selected_value.add_selected(),null===e?r.current_display.addClass("fv_choice_placeholder").empty().text(r.name):r.current_display.removeClass("fv_choice_placeholder").empty().append(e.get_display()),r.hide_list(),!t.val_event){var i;if(r.filter_input.is(":focus")){var o=$("input[tabindex != '-1']:visible,textarea[tabindex != '-1']:visible,button[tabindex != '-1']:visible");if(o){var n=o.index(r.filter_input);-1!==n&&(i=o[n+1])}}i?i.focus():r.blur()}return r.clear_filter_on_select&&r.filter_input.val(""),t.ignore_change||r.did_change(t),r},FVChoiceField.prototype.move_up=function(){var e=this;if(e.current_highlight){e.current_highlight.remove_highlight();var t=e.option_array.indexOf(e.current_highlight);t>0?(e.current_highlight=e.option_array[t-1],e.current_highlight.add_highlight(),e.move_into_view()):e.current_highlight=null}return e},FVChoiceField.prototype.move_down=function(){var e=this;if(e.current_highlight){var t=e.option_array.indexOf(e.current_highlight);t<e.option_array.length-1&&(e.current_highlight.remove_highlight(),e.current_highlight=e.option_array[t+1],e.current_highlight.add_highlight(),e.move_into_view())}else e.current_highlight=e.option_array[0],e.current_highlight&&e.current_highlight.add_highlight();return e},FVChoiceField.prototype.move_into_view=function(e){var t=this;return void 0===e&&(e=t.current_highlight),setTimeout(function(){var r;r=e?e.element.offset().top:0,t.choice_list.scrollTop(t.choice_list.scrollTop()-t.choice_list.offset().top+r-50)},1),t},FVChoiceField.prototype.add_option=function(e){var t=this;return t.option_array.push(e),t.choice_list.append(e.element),t},FVChoiceField.prototype.default_click=function(e,t){var r=this;return e.preventDefault(),e.stopPropagation(),e.originalEvent&&(e.originalEvent.preventDefault(),e.originalEvent.stopPropagation()),r.select_option(t),r},FVChoiceField.prototype.finalize_option=function(e){var t=this;return e.appendTo(t.choice_list),t},FVChoiceField.prototype.select_highlighted=function(){var e=this;return e.current_highlight&&e.select_option(e.current_highlight),e},FVChoiceField.prototype.input_focus=function(){var e=this;return e.clear_filter_on_focus&&e.filter_input.val(""),e.show_list(),e.did_focus(),e},FVChoiceField.prototype.focus=function(){var e=this;return e.filter_input.focus(),FVField.prototype.focus.call(this)},FVChoiceField.prototype.blur=function(){var e=this;return e.hide_list(),e.did_blur(),FVField.prototype.blur.call(this)},FVChoiceField.prototype.val=function(e,t){var r=this;if(0===arguments.length)return r.selected_value?r.selected_value.get_value():null;if(void 0!==e)for(var i=0;i<r.option_array.length;i++){var o=r.option_array[i];if(o.matches_value(e)){t=t||{},t.val_event=!0,r.select_option(o,t);break}}return r},fieldval_ui_extend(FVDateField,FVField),FVDateField.character_width=14,FVDateField.padding_width=4,FVDateField.prototype.add_element_from_component=function(e,t){var r=this;if(0===t){var i=e;r.inputs.push(null),r.input_holder.append($("<div />").addClass("fv_date_separator").text(i))}else{var o=t[t.length-1],n=$("<input />").attr({placeholder:e,size:o,maxlength:o}).addClass("fv_date_input").css({width:o*FVDateField.character_width+FVDateField.padding_width}).on("keyup",function(){r.did_change()}).on("focus",function(){r.did_focus()}).on("blur",function(){var e=n.val(),i=DateVal.pad_to_valid(e,t);n.val(i),r.did_blur()});r.inputs.push(n),r.input_holder.append(n)}return r},FVDateField.prototype.icon=function(){var e=this;return e},FVDateField.prototype.change_name=function(e){var t=this;return FVDateField.superClass.change_name.call(this,e),t.input.attr("placeholder",e),t},FVDateField.prototype.disable=function(){for(var e=this,t=0;t<e.inputs.length;t++){var r=e.inputs[t];r&&r.attr("disabled","disabled")}return FVField.prototype.disable.call(this)},FVDateField.prototype.enable=function(){for(var e=this,t=0;t<e.inputs.length;t++){var r=e.inputs[t];r&&r.attr("disabled",null)}return FVField.prototype.enable.call(this)},FVDateField.prototype.focus=function(){var e=this,t=e.inputs[0];return t&&t.focus(),FVField.prototype.focus.call(this)},FVDateField.prototype.blur=function(){var e=this;e.suppress_blur=!0;for(var t=0;t<e.inputs.length;t++){var r=e.inputs[t];r&&r.blur()}return e.suppress_blur=!1,e.did_blur(),FVField.prototype.blur.call(this)},FVDateField.prototype.val=function(e,t){var r=this;if(t=t||{},0===arguments.length){for(var i="",o=0;o<r.format_array.length;o++){var n=r.format_array[o],l=DateVal.date_components[n];if(0===l)i+=n;else{var a=r.inputs[o],s=a.val().toString();i+=DateVal.pad_to_valid(s,l)}}return i}if(null!=e){"number"==typeof e?e=DateVal.date_with_format_array(new Date(e),r.format_array):e instanceof Date&&(e=DateVal.date_with_format_array(e,r.format_array));var d=DateVal.date(r.format_string,{emit:DateVal.EMIT_COMPONENT_ARRAY}).check(e,function(e){as_components=e});if(d)return void console.error("Invalid format passed to .val of FVDateField");for(var o=0;o<r.format_array.length;o++){var n=r.format_array[o],l=DateVal.date_components[n];if(0===l)i+=n;else{var a=r.inputs[o];a.val(as_components[o])}}t.ignore_change||r.did_change(t)}return r},fieldval_ui_extend(FVBooleanField,FVField),FVBooleanField.prototype.disable=function(){var e=this;return e.input.attr("disabled","disabled"),FVField.prototype.disable.call(this)},FVBooleanField.prototype.enable=function(){var e=this;return e.input.attr("disabled",null),FVField.prototype.enable.call(this)},FVBooleanField.prototype.focus=function(){var e=this;return e.input.focus(),FVField.prototype.focus.call(this)},FVBooleanField.prototype.blur=function(){var e=this;return e.input.blur(),FVField.prototype.blur.call(this)},FVBooleanField.prototype.val=function(e,t){var r=this;return t=t||{},0===arguments.length?r.input.is(":checked"):("true"===e?e=!0:"false"===e&&(e=!1),r.input.prop("checked",e),t.ignore_change||r.did_change(t),r)},fieldval_ui_extend(FVObjectField,FVField),FVObjectField.prototype.init=function(){var e=this;for(var t in e.fields)if(e.fields.hasOwnProperty(t)){var r=e.fields[t];r.init()}return e},FVObjectField.prototype.remove=function(e){var t=this;for(var r in t.fields)if(t.fields.hasOwnProperty(r)){var i=t.fields[r];i.remove(!1,{ignore_change:!0})}return FVField.prototype.remove.call(this,e)},FVObjectField.prototype.add_field=function(e,t){var r=this;return t.element.appendTo(r.fields_element),r.fields[e]=t,t.parent=r,r},FVObjectField.prototype.remove_field=function(e,t){var r=this;t=t||{};var i,o;if("string"==typeof e)i=r.fields[e],o=e;else{if(!(e instanceof FVField))throw new Error("FVObjectField.remove_field only accepts strings or FVField instances");for(var n in r.fields)r.fields.hasOwnProperty(n)&&r.fields[n]===e&&(i=r.fields[n],o=n)}return i?(i.remove(!0),delete r.fields[o],t.ignore_change||r.did_change(),i):void 0},FVObjectField.prototype.change_name=function(e){var t=this;return FVObjectField.superClass.change_name.call(this,e),t},FVObjectField.prototype.disable=function(){var e=this;for(var t in e.fields)if(e.fields.hasOwnProperty(t)){var r=e.fields[t];r.disable()}return FVField.prototype.disable.call(this)},FVObjectField.prototype.enable=function(){var e=this;for(var t in e.fields)if(e.fields.hasOwnProperty(t)){var r=e.fields[t];r.enable()}return FVField.prototype.enable.call(this)},FVObjectField.prototype.focus=function(){var e=this;for(var t in e.fields)if(e.fields.hasOwnProperty(t)){var r=e.fields[t];if(r)return r.focus(),e}return FVField.prototype.focus.call(this)},FVObjectField.prototype.blur=function(){var e=this;e.suppress_blur=!0;for(var t in e.fields)if(e.fields.hasOwnProperty(t)){var r=e.fields[t];r.blur()}return e.suppress_blur=!1,e.did_blur(),FVField.prototype.blur.call(this)},FVObjectField.prototype.error=function(e){var t=this;if(FVObjectField.superClass.error.call(this,e),t.error_message.empty(),e){if(void 0===e.error)return console.error("No error provided"),t;if(5===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var r=$("<ul />"),i=0;i<e.errors.length;i++){var o=e.errors[i];5===o.error?t.fields_error(o):r.append($("<li />").text(o.error_message))}t.error_message.append(r)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error();return t},FVObjectField.prototype.fields_error=function(e){var t=this;if(e){var r=e.invalid||{},i=e.missing||{},o=e.unrecognized||{};for(var n in t.fields)if(t.fields.hasOwnProperty(n)){var l=t.fields[n],a=r[n]||i[n]||o[n]||null;l.error(a)}}else for(var n in t.fields)if(t.fields.hasOwnProperty(n)){var l=t.fields[n];l.error(null)}return t},FVObjectField.prototype.val=function(e,t){var r=this;if(t=t||{},0===arguments.length){var i={};for(var o in r.fields)if(r.fields.hasOwnProperty(o)){var n=r.fields[o];if(n.output_flag!==!1){var l=n.val();null!=l&&(i[o]=l)}}return i}t.ignore_parent_change=!0;for(var o in e){var n=r.fields[o];n&&n.val(e[o],t)}return t.ignore_change||r.did_change(t),r},function(e,t,r,i){function o(t,i){this.w=e(r),this.el=e(t),this.options=e.extend({},a,i),this.init()}var n="ontouchstart"in r,l=function(){var e=r.createElement("div"),i=r.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",i.appendChild(e);var o=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return i.removeChild(e),!!o}(),a={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",placeClass:"dd-placeholder",threshold:20};o.prototype={init:function(){var r=this;r.reset(),r.placeEl=e('<div class="'+r.options.placeClass+'"/>');var i=function(t){var i=e(t.target);if(i.hasClass(r.options.handleClass)||(i=i.closest("."+r.options.handleClass)),i.length&&!r.dragEl&&(r.isTouch=/^touch/.test(t.type),!r.isTouch||1===t.touches.length)){var o=i.closest("."+r.options.itemClass);o[0].parentNode===r.el[0]&&(t.preventDefault(),r.dragStart(t.touches?t.touches[0]:t))}},o=function(e){r.dragEl&&(e.preventDefault(),r.dragMove(e.touches?e.touches[0]:e))},l=function(e){r.dragEl&&(e.preventDefault(),r.dragStop(e.touches?e.touches[0]:e))};n&&(r.el[0].addEventListener("touchstart",i,!1),t.addEventListener("touchmove",o,!1),t.addEventListener("touchend",l,!1),t.addEventListener("touchcancel",l,!1)),r.el.on("mousedown",i),r.w.on("mousemove",o),r.w.on("mouseup",l)},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.hasNewRoot=!1,this.pointEl=null},setParent:function(e){e.data("fv_parent_list",this)},dragStart:function(t){var o=this.mouse,n=e(t.target),l=n.closest(this.options.itemNodeName);this.placeEl.css("height",l.height()),this.placeEl.css("width",l.width()),this.placeEl.css("display",l.css("display")),o.offsetX=t.offsetX!==i?t.offsetX:t.pageX-n.offset().left,o.offsetY=t.offsetY!==i?t.offsetY:t.pageY-n.offset().top,o.startX=o.lastX=t.pageX,o.startY=o.lastY=t.pageY,this.dragRootEl=this.el,this.el_offset=this.el.offset(),this.dragEl=e(r.createElement(this.options.listNodeName)).addClass(this.options.dragClass),this.dragEl.css("width",l.width()),l.after(this.placeEl),l[0].parentNode.removeChild(l[0]),l.appendTo(this.dragEl),e(this.el).append(this.dragEl),this.dragEl.css({left:t.pageX-o.offsetX-this.el_offset.left,top:t.pageY-o.offsetY-this.el_offset.top})},dragStop:function(){var e=this.dragEl.children(this.options.itemNodeName).first();e[0].parentNode.removeChild(e[0]),this.placeEl.replaceWith(e),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(i){var o=this.options,n=this.mouse;this.dragEl.css({left:i.pageX-n.offsetX-this.el_offset.left,top:i.pageY-n.offsetY-this.el_offset.top}),n.lastX=n.nowX,n.lastY=n.nowY,n.nowX=i.pageX,n.nowY=i.pageY,n.distX=n.nowX-n.lastX,n.distY=n.nowY-n.lastY,n.lastDirX=n.dirX,n.lastDirY=n.dirY,n.dirX=0===n.distX?0:n.distX>0?1:-1,n.dirY=0===n.distY?0:n.distY>0?1:-1;var a=Math.abs(n.distX)>Math.abs(n.distY)?1:0;if(!n.moving)return n.dirAx=a,void(n.moving=!0);n.dirAx!==a?(n.distAxX=0,n.distAxY=0):(n.distAxX+=Math.abs(n.distX),0!==n.dirX&&n.dirX!==n.lastDirX&&(n.distAxX=0),n.distAxY+=Math.abs(n.distY),0!==n.dirY&&n.dirY!==n.lastDirY&&(n.distAxY=0)),n.dirAx=a;l||(this.dragEl[0].style.visibility="hidden");var s=e(r.elementFromPoint(i.pageX-r.body.scrollLeft,i.pageY-(t.pageYOffset||r.documentElement.scrollTop)));if(s.hasClass(o.itemClass)||(s=s.closest("."+o.itemClass)),l||(this.dragEl[0].style.visibility="visible"),s.hasClass(o.handleClass))s=s.closest("."+o.itemClass);else if(!s.length||!s.hasClass(o.itemClass))return;var d=e(s[0].parentNode);if(this.el[0]===d[0]){this.pointEl=s;var u=(i.pageY-this.pointEl.offset().top,i.pageY-this.pointEl.offset().top,i.pageX<this.pointEl.offset().left+this.pointEl.width()/2),p=i.pageY<this.pointEl.offset().top+this.pointEl.height()/2;"block"===this.pointEl.css("display")?p?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl):p&&u?this.pointEl.before(this.placeEl):p||u||this.pointEl.after(this.placeEl)}}},e.fn.nestable=function(t){var r=this,i=this;return r.each(function(){var r=e(this).data("nestable");r?"string"==typeof t&&"function"==typeof r[t]&&(i=r[t]()):(e(this).data("nestable",new o(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),i||r}}(window.jQuery||window.Zepto,window,document),fieldval_ui_extend(FVArrayField,FVField),FVArrayField.prototype.reorder=function(){var e=this;e.fields=[];for(var t=e.fields_element.children(),r=0;r<t.length;r++){var i=$(t[r]),o=i.data("field");e.fields.push(o)}return e},FVArrayField.prototype.create_add_field_button=function(){var e=this,t=$("<button/>",{type:"button"}).addClass("fv_add_field_button").text(e.add_button_text).on(FVForm.button_event,function(t){t.preventDefault(),e.add_field_clicked()});return e.add_field_buttons.push(t),t},FVArrayField.prototype.add_field_clicked=function(){var e=this,t=e.new_field(e.fields.length);return t&&-1===e.fields.indexOf(t)&&e.add_field(t),e},FVArrayField.prototype.new_field=function(){throw new Error("FVArrayField.new_field must be overriden to create fields")},FVArrayField.prototype.add_field=function(e,t){var r=this;return e.in_array(r,function(){r.remove_field(e)}),e.element.appendTo(r.fields_element),r.fields.push(e),e.parent=r,r.input_holder.nestable("init"),r.is_disabled&&e.disable(),t||r.did_change(),r},FVArrayField.prototype.remove=function(e){for(var t=this,r=0;r<t.fields.length;r++){var i=t.fields[r];i.remove(!1,{ignore_change:!0})
}FVField.prototype.remove.call(this,e)},FVArrayField.prototype.remove_field=function(e,t){var r=this;t=t||{};var i,o;if("number"==typeof e&&e%1===0&&e>=0)o=e,i=r.fields[e];else{if(!(e instanceof FVField))throw new Error("FVArrayField.remove_field only accepts non-negative integers or FVField instances");for(var n=0;n<r.fields.length;n++)if(r.fields[n]===e){o=n,i=r.fields[n];break}}return i?(i.remove(!0),r.fields.splice(o,1),t.ignore_change||r.did_change(),i):void 0},FVArrayField.prototype.error=function(e){FVArrayField.superClass.error.call(this,e)},FVArrayField.prototype.fields_error=function(e){var t=this;if(e)for(var r=e.invalid||{},i=e.missing||{},o=e.unrecognized||{},n=0;n<t.fields.length;n++){var l=t.fields[n],a=r[n]||i[n]||o[n]||null;l.error(a)}else for(var n=0;n<t.fields.length;n++){var l=t.fields[n];l.error(null)}return t},FVArrayField.prototype.clear_errors=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.clear_errors()}return e},FVArrayField.prototype.disable=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.disable()}for(var t=0;t<e.add_field_buttons.length;t++){var i=e.add_field_buttons[t];i.hide()}return FVField.prototype.disable.call(this)},FVArrayField.prototype.enable=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.enable()}for(var t=0;t<e.add_field_buttons.length;t++){var i=e.add_field_buttons[t];i.show()}return FVField.prototype.enable.call(this)},FVArrayField.prototype.focus=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];if(r)return r.focus(),e}return FVField.prototype.focus.call(this)},FVArrayField.prototype.blur=function(){var e=this;e.suppress_blur=!0;for(var t=0;t<e.fields.length;t++){var r=e.fields[t];r.blur()}return e.suppress_blur=!1,e.did_blur(),FVField.prototype.blur.call(this)},FVArrayField.prototype.error=function(e){var t=this;if(t.error_message.empty(),e){if(void 0===e.error)return console.error("No error provided"),t;if(5===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var r=$("<ul />"),i=0;i<e.errors.length;i++){var o=e.errors[i];5===o.error?t.fields_error(o):r.append($("<li />").text(o.error_message))}t.error_message.append(r)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error();return t},FVArrayField.prototype.val=function(e,t){var r=this;if(t=t||{},0===arguments.length){for(var i=[],o=0;o<r.fields.length;o++){var n=r.fields[o],l=n.val();i.push(l)}return i}if(e){t.ignore_parent_change=!0;for(var o=0;o<e.length;o++){var n=r.fields[o];n||(n=r.new_field(o),n&&-1===r.fields.indexOf(n)&&r.add_field(n,!0)),n||(n=r.fields[o]),n.val(e[o],t)}if(e.length<r.fields.length){for(var a=[],o=e.length;o<r.fields.length;o++)a.push(r.fields[o]);for(var o=0;o<a.length;o++){var n=a[o];n.remove(!1,{ignore_change:!0})}}t.ignore_change||r.did_change(t)}return r},fieldval_ui_extend(FVKeyValueField,FVField),FVKeyValueField.prototype.create_add_field_button=function(){var e=this,t=$("<button />",{type:"button"}).addClass("fv_add_field_button").text(e.add_button_text).on(FVForm.button_event,function(t){t.preventDefault(),e.add_field_clicked()});return e.add_field_buttons.push(t),t},FVKeyValueField.prototype.add_field_clicked=function(){var e=this,t=e.new_field(e.fields.length);return t&&-1===e.fields.indexOf(t)&&e.add_field(t),e},FVKeyValueField.prototype.new_field=function(){throw new Error("FVKeyValueField.new_field must be overriden to create fields")},FVKeyValueField.prototype.add_field=function(e,t){var r=this;return e.in_key_value(r,function(){r.remove_field(e)}),e.element.appendTo(r.fields_element),r.fields.push(e),e.parent=r,e.name_val("",{ignore_change:!0}),r.is_disabled&&e.disable(),t||r.did_change(),r},FVKeyValueField.prototype.change_key_name=function(e,t,r){var i=this;if(void 0!==e){var o=i.keys[e];if(o!==r)throw new Error("Old key name does not match this field ",e);delete i.keys[e]}null===t&&(t="");for(var n=t,l=2;void 0!==i.keys[n];)n=t+"_"+l++;return i.keys[n]=r,n},FVKeyValueField.prototype.remove_field=function(e,t){var r=this;t=t||{};var i,o;if("string"==typeof e){for(var n=0;n<r.fields.length;n++)if(r.fields[n].name_val()===e){i=r.fields[n],o=n;break}}else{if(!(e instanceof FVField))throw new Error("FVKeyValueField.remove_field only accepts strings or FVField instances");for(var n=0;n<r.fields.length;n++)if(r.fields.hasOwnProperty(n)&&r.fields[n]===e){i=r.fields[n],o=n;break}}return i?(i.remove(!0),r.fields.splice(o,1),delete r.keys[i.key_name],t.ignore_change||r.did_change(),i):void 0},FVKeyValueField.prototype.error=function(e){var t=this;return FVKeyValueField.superClass.error.call(this,e),t},FVKeyValueField.prototype.fields_error=function(e){var t=this;if(e){var r=e.invalid||{},i=e.missing||{},o=e.unrecognized||{};for(var n in t.keys)if(t.keys.hasOwnProperty(n)){var l=t.keys[n],a=r[n]||i[n]||o[n]||null;l.error(a)}}else for(var n in t.keys)if(t.keys.hasOwnProperty(n)){var l=t.keys[n];l.error(null)}return t},FVKeyValueField.prototype.clear_errors=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.clear_errors()}return e},FVKeyValueField.prototype.disable=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.disable()}for(var t=0;t<e.add_field_buttons.length;t++){var i=e.add_field_buttons[t];i.hide()}return FVField.prototype.disable.call(this)},FVKeyValueField.prototype.enable=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.enable()}for(var t=0;t<e.add_field_buttons.length;t++){var i=e.add_field_buttons[t];i.show()}return FVField.prototype.enable.call(this)},FVKeyValueField.prototype.focus=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];if(r)return r.focus(),e}return FVField.prototype.focus.call(this)},FVKeyValueField.prototype.blur=function(){var e=this;e.suppress_blur=!0;for(var t=0;t<e.fields.length;t++){var r=e.fields[t];r.blur()}return e.suppress_blur=!1,e.did_blur(),FVField.prototype.blur.call(this)},FVKeyValueField.prototype.remove=function(e){for(var t=this,r=0;r<t.fields.length;r++){var i=t.fields[r];i.remove(!1,{ignore_change:!0})}return FVField.prototype.remove.call(this,e)},FVKeyValueField.prototype.error=function(e){var t=this;if(t.error_message.empty(),e){if(void 0===e.error)return console.error("No error provided"),t;if(5===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var r=$("<ul />"),i=0;i<e.errors.length;i++){var o=e.errors[i];5===o.error?t.fields_error(o):r.append($("<li />").text(o.error_message))}t.error_message.append(r)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error();return t},FVKeyValueField.prototype.val=function(e,t){var r=this;if(t=t||{},0===arguments.length){var i={};for(var o in r.keys)if(r.keys.hasOwnProperty(o)){var n=r.keys[o];if(n.output_flag!==!1){var l=n.val();i[o]=l}}return i}if(t.ignore_parent_change=!0,e){for(var o in r.keys)if(r.keys.hasOwnProperty(o)&&void 0===e[o]){var n=r.keys[o];r.remove_field(n,{ignore_change:!0})}for(var o in e)if(e.hasOwnProperty(o)){var n=r.keys[o];n||(n=r.new_field(o),n&&-1===r.fields.indexOf(n)&&r.add_field(n,!0)),n.val(e[o],t),n.name_val(o,{ignore_change:!0})}}return t.ignore_change||r.did_change(t),r},"function"!=typeof Object.getPrototypeOf&&(Object.getPrototypeOf="object"==typeof"test".__proto__?function(e){return e.__proto__}:function(e){return e.constructor.prototype}),fieldval_ui_extend(FVProxyField,FVField),FVProxyField.prototype.init=function(){var e=this;return e.init_called=!0,e.inner_field&&e.inner_field.init(),e},FVProxyField.prototype.replace=function(e,t){var r=this;t=t||{},r.inner_field=e,r.init_called&&r.inner_field.init();var i=[],o=[],n=!1;r.element.children().each(function(e,t){t===r.title[0]?n=!0:t!==r.input_holder[0]&&t!==r.error_message[0]&&(n?o.push(t):i.push(t))}),r.element.replaceWith(r.inner_field.element),r.element=r.inner_field.element,r.element.prepend(i),r.element.append(o),void 0!==r.last_val&&r.inner_field.val(r.last_val);for(var l=["output_flag","is_in_array","key_value_parent","is_in_key_value","key_name","is_disabled"],a=0;a<l.length;a++)e[l[a]]=r[l[a]];for(var s=[],d=0;d<r.on_change_callbacks.length;d++)s.push(r.on_change_callbacks[d]);var u=[];if(void 0!==r.on_submit_callbacks)for(var d=0;d<r.on_submit_callbacks.length;d++)u.push(r.on_submit_callbacks[d]);var p=Object.getPrototypeOf(e);for(var _ in p)p.hasOwnProperty(_)&&(r[_]=p[_]);for(var _ in e)e.hasOwnProperty(_)&&(r[_]=e[_]);for(var d=0;d<s.length;d++)r.on_change_callbacks.push(s[d]);if(void 0!==r.on_submit_callbacks)for(var d=0;d<u.length;d++)r.on_submit_callbacks.push(u[d]);r.is_in_key_value&&(r.in_key_value(r.key_value_parent,r.key_value_remove_callback),r.name_input.val(r.key_name)),r.is_in_array&&r.in_array(r.array_parent,r.array_remove_callback),r.is_disabled&&r.disable();for(var _=0;_<r.on_replace_callbacks.length;_++)r.on_replace_callbacks[_]();return t.ignore_change||r.did_change(t),r},FVProxyField.prototype.on_replace=function(e){var t=this;return t.on_replace_callbacks.push(e),t},FVProxyField.prototype.val=function(e,t){var r=this;return t=t||{},r.inner_field?r.inner_field.val.apply(r.inner_field,arguments):void(0!==arguments.length&&(r.last_val=e,t.ignore_change||r.did_change(t)))},fieldval_ui_extend(FVForm,FVObjectField),FVForm.button_event="click",FVForm.is_mobile=/android|webos|iphone|ipad|ipod|blackberry|iemobile|nokia|series40|x11|opera mini/i.test(navigator.userAgent.toLowerCase()),($.fn.tap||$.tap)&&(FVForm.button_event="tap");